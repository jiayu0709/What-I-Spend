<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>捷徑金鑰</title>
</head>
<body style="font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text';padding:20px;">
  <h2>捷徑專用金鑰</h2>
  <p id="status">讀取中…</p>

  <pre id="token"
       style="padding:12px;background:#f4f4f4;border-radius:12px;
              white-space:pre-wrap;word-break:break-all;"></pre>

  <button id="regen">重新產生</button>
  <button id="copy">複製</button>

  <script type="module" src="app.js"></script>
  <script type="module">
    import { db } from "./firebase-config.js";
    import { doc, getDoc, setDoc } from
      "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    await window.firebaseReady;
    const user = await window.requireAuth();
    if (!user) return;

    const ref = doc(db, "users", user.uid);
    const status = document.getElementById("status");
    const tokenEl = document.getElementById("token");

    function genToken() {
      return crypto.randomUUID().replace(/-/g, "");
    }

    async function load() {
      const snap = await getDoc(ref);
      let token = snap.data()?.shortcutToken;
      if (!token) {
        token = genToken();
        await setDoc(ref, { shortcutToken: token }, { merge: true });
      }
      tokenEl.textContent = token;
      status.textContent = "已登入";
    }

    document.getElementById("regen").onclick = async () => {
      const token = genToken();
      await setDoc(ref, { shortcutToken: token }, { merge: true });
      tokenEl.textContent = token;
      alert("已重新產生");
    };

    document.getElementById("copy").onclick = async () => {
      await navigator.clipboard.writeText(tokenEl.textContent);
      alert("已複製");
    };

    load();
  </script>
</body>
</html>