<script type="module" src="app.js"></script>
<script type="module">
  import { db } from "./firebase-config.js";
  import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const status = document.getElementById("status");
  const tokenEl = document.getElementById("token");

  function genToken() {
    return crypto.randomUUID().replace(/-/g, "");
  }

  try {
    await window.firebaseReady;

    const user = await window.requireAuth();
    if (!user) throw new Error("not logged in");

    const ref = doc(db, "users", user.uid);

    async function load() {
      status.textContent = "讀取中…";
      const snap = await getDoc(ref);

      let token = snap.data()?.shortcutToken;
      if (!token) {
        token = genToken();
        await setDoc(ref, { shortcutToken: token }, { merge: true });
      }

      tokenEl.textContent = token;
      status.textContent = "已登入 ✅";
    }

    document.getElementById("regen").onclick = async () => {
      const t = genToken();
      await setDoc(ref, { shortcutToken: t }, { merge: true });
      tokenEl.textContent = t;
      alert("已重新產生");
    };

    document.getElementById("copy").onclick = async () => {
      const t = tokenEl.textContent.trim();
      if (!t) return alert("目前沒有 token");
      await navigator.clipboard.writeText(t);
      alert("已複製");
    };

    await load();
  } catch (e) {
    console.error(e);
    status.textContent = "發生錯誤：";
    tokenEl.textContent = String(e?.message || e);
  }
</script>