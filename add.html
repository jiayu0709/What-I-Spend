<!doctype html>
<html lang="zh-Hant">
<head>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="theme.css">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="What I Spend">
  <meta charset="utf-8" />
  <meta
  name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <title>æ–°å¢</title>
  <style>
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--app-bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    }
    .app{min-height:100vh;padding-bottom:var(--tab-height)}
    .page{max-width:520px;margin:0 auto;padding:18px var(--page-padding) 28px}
    .nav-title{font-size:42px;font-weight:800;margin:10px 0 14px;letter-spacing:-.5px}
    .section{margin-top:18px}
    .label{font-size:14px;font-weight:800;color:var(--secondary);margin:10px 0 8px}
    .card{background:var(--card-bg);border-radius:var(--radius);padding:16px}
    .segment{
      display:grid;grid-template-columns:1fr 1fr;
      background:var(--card-bg);border-radius:12px;padding:4px;
    }
    .seg-btn{
      border:0;background:transparent;padding:10px 0;border-radius:10px;
      font-weight:800;color:var(--secondary);cursor:pointer;
    }
    .seg-btn.active{background:#fff;color:var(--text)}
    .field{display:grid;gap:8px;margin-top:14px}
    .field:first-child{margin-top:0}
    .input, select{
      width:100%;padding:12px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.12);
      background:#fff;font-size:16px;
    }
    input, select {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    input[type="date"]{
      display:block;
      appearance:none;
      -webkit-appearance:none;
    }
    .field, .card { min-width:0; }

    .save{
      margin-top:14px;
      width:100%;
      padding:14px 16px;
      border:0;border-radius:16px;
      background:var(--card-bg);
      font-size:18px;font-weight:800;
      cursor:pointer;
      color: var(--accent-text);
    }

    /* =================================================
       iOS-style tap feedbackï¼ˆåªæ”¹æŒ‰éˆ•/å¯é»æ“Šå…ƒä»¶ï¼‰
       ================================================= */
    a, button, .seg-btn, .save, .tab{ -webkit-tap-highlight-color: transparent; }
    .seg-btn, .save, .tab, button{
      user-select:none; -webkit-user-select:none;
      transition: opacity .15s ease, transform .10s ease, background-color .15s ease;
    }
    .seg-btn:active{ opacity:.65; transform:scale(.98); }
    .save:active{ opacity:.65; transform:scale(.98); }
    .tab:active{ opacity:.6; transform:scale(.98); }
    .seg-btn:focus, .save:focus, .tab:focus, button:focus{ outline:none; }
    /* ===============================
    iOS æ—¥æœŸ input æ–‡å­—é¡è‰²ï¼ˆçµ±ä¸€æ§è‰²ï¼‰
    =============================== */
    input[type="date"]{
      color: var(--accent-text);
      -webkit-text-fill-color: var(--accent-text);
    }

    input[type="date"]::-webkit-datetime-edit{
      color: var(--accent-text);
    }

    input[type="date"]::-webkit-datetime-edit-text,
    input[type="date"]::-webkit-datetime-edit-month-field,
    input[type="date"]::-webkit-datetime-edit-day-field,
    input[type="date"]::-webkit-datetime-edit-year-field{
      color: var(--accent-text);
    }
  </style>
</head>
<body>
  <div class="app">
    <main class="page">
      <div class="nav-title">æ–°å¢</div>

      <!-- é¡å‹ï¼ˆsegmentedï¼‰ -->
      <section class="section">
        <div class="label">é¡å‹</div>
        <div class="segment" role="tablist" aria-label="é¡å‹">
          <button class="seg-btn active" id="btn-expense" type="button" aria-pressed="true">æ”¯å‡º</button>
          <button class="seg-btn" id="btn-income" type="button" aria-pressed="false">æ”¶å…¥</button>
        </div>
      </section>

      <!-- æ—¥æœŸ/åˆ†é¡/é‡‘é¡/å‚™è¨» -->
      <section class="section">
        <div class="card">
          <div class="field">
            <div class="label">æ—¥æœŸ</div>
            <input class="input" type="date" id="date" />
          </div>

          <div class="field">
            <div class="label">åˆ†é¡</div>
            <select class="input" id="category">
            </select>
          </div>

          <div class="field">
            <div class="label">é‡‘é¡</div>
            <input class="input" type="number" id="amount" inputmode="decimal" placeholder="è¼¸å…¥é‡‘é¡" />
          </div>

          <div class="field">
            <div class="label">å‚™è¨»</div>
            <input class="input" type="text" id="note" placeholder="å‚™è¨»ï¼ˆå¯ç©ºï¼‰" />
          </div>
        </div>

        <button class="save" id="saveBtn" type="button">å„²å­˜</button>
      </section>
    </main>

    <!-- Tab Bar -->
    <nav class="tabbar" aria-label="Tab Bar">
      <div class="tabbar-inner">
        <a class="tab" href="add.html"><div class="icon">ï¼‹</div><div>æ–°å¢</div></a>
        <a class="tab" href="month.html"><div class="icon">â–¦</div><div>æœ¬æœˆ</div></a>
        <a class="tab" href="year.html"><div class="icon">â›</div><div>çµ±è¨ˆ</div></a>
      </div>
    </nav>
  </div>

  <!-- âœ… module ç‰ˆ app.jsï¼ˆåªåš persistenceï¼‰ -->
  <script type="module" src="app.js"></script>

  <script type="module">
    // âœ… åªèª¿æ•´ã€Œå¯«å…¥æµç¨‹ã€ï¼šå…¶é¤˜ UI/åŠŸèƒ½å®Œå…¨ä¿ç•™
    import { auth, db } from "./firebase-config.js";
    import { addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ===== categories =====
    const expenseCategories = ["é¤é£²ğŸ¥£","é£²æ–™ğŸ¥¤","äº¤é€šğŸ›µ","æ—¥ç”¨ğŸ›ï¸","å¨›æ¨‚ğŸ®","é†«ç™‚ğŸ¥","æ²»è£ğŸ‘—","å®¶ç”¨ğŸ ","æ—…éŠğŸ§³","å…¶ä»–"];
    const incomeCategories  = ["è–ªè³‡ğŸ’¼","çé‡‘ğŸ","å…¼è·ğŸ§‘â€ğŸ’»","æŠ•è³‡ğŸ“ˆ","é€€æ¬¾â†©ï¸","å…¶ä»–"];

    // ===== helpers =====
    function pad2(n){ return String(n).padStart(2,"0"); }
    function todayYMD(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function nowHHMM(){
      const d = new Date();
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }
    function timeToMinutesFromHHmm(hhmm){
      if(!hhmm) return null;
      const [h,m] = hhmm.split(":").map(n => parseInt(n,10));
      if(!Number.isFinite(h) || !Number.isFinite(m)) return null;
      return h * 60 + m; // 0~1439
    }
    function monthKeyFromDateStr(ymd){
      return (ymd && /^\d{4}-\d{2}-\d{2}$/.test(ymd)) ? ymd.slice(0,7) : "";
    }
    function parseAmount(v){
      const n = Number(String(v ?? "").replace(/,/g,""));
      return isFinite(n) ? n : NaN;
    }

    // ===== DOM =====
    const btnExpense = document.getElementById("btn-expense");
    const btnIncome  = document.getElementById("btn-income");
    const categorySelect = document.getElementById("category");
    const dateInput = document.getElementById("date");
    const amountInput = document.getElementById("amount");
    const noteInput = document.getElementById("note");
    const saveBtn = document.getElementById("saveBtn");

    let currentType = "expense";
    let uid = null; // ç™»å…¥æˆåŠŸå¾Œæ‰æœƒæœ‰

    // ===== render categories =====
    function updateCategoryOptions(type){
      const list = (type === "income") ? incomeCategories : expenseCategories;
      const prev = categorySelect.value;

      categorySelect.innerHTML = "";
      for (const name of list) {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        categorySelect.appendChild(opt);
      }

      categorySelect.value = list.includes(prev) ? prev : list[0];
    }

    function setType(t){
      currentType = (t === "income") ? "income" : "expense";
      const isExpense = currentType === "expense";
      btnExpense.classList.toggle("active", isExpense);
      btnIncome.classList.toggle("active", !isExpense);
      btnExpense.setAttribute("aria-pressed", String(isExpense));
      btnIncome.setAttribute("aria-pressed", String(!isExpense));
      updateCategoryOptions(currentType);
    }

    // ===== å…ˆæŠŠ UI å¡«èµ·ä¾†ï¼ˆä¸ç­‰ç™»å…¥ï¼‰=====
    dateInput.value = todayYMD();
    setType("expense");

    btnExpense.addEventListener("click", () => setType("expense"));
    btnIncome.addEventListener("click", () => setType("income"));

    // ===== è®€æ·å¾‘åƒæ•¸ï¼ˆé å¡«ï¼‰=====
    const qs = new URLSearchParams(location.search);
    const qsType = qs.get("type");
    const qsAmount = qs.get("amount");
    const qsCategory = qs.get("category");
    const qsNote = qs.get("note");
    const qsDate = qs.get("date");
    const autoSave = qs.get("autosave") === "1";

    if (qsType === "income" || qsType === "expense") setType(qsType);
    if (qsDate && /^\d{4}-\d{2}-\d{2}$/.test(qsDate)) dateInput.value = qsDate;
    if (qsAmount) amountInput.value = qsAmount;
    if (qsNote) noteInput.value = qsNote;

    // category å¿…é ˆåœ¨ options ç”Ÿæˆå¾Œæ‰é¸å¾—åˆ°
    if (qsCategory && [...categorySelect.options].some(o => o.value === qsCategory)) {
      categorySelect.value = qsCategory;
    }

    // ===== ç™»å…¥ï¼ˆåªå½±éŸ¿èƒ½ä¸èƒ½å¯«å…¥ï¼‰=====
    await window.firebaseReady;
    const user = await window.waitForAuthReady();

    if (user) {
      uid = user.uid;
      saveBtn.disabled = false;
    } else {
      // æ²’ç™»å…¥ï¼šæŒ‰å„²å­˜å°±å°å»ç™»å…¥é 
      saveBtn.disabled = false;
    }

    async function ensureLoginOrRedirect(){
      const user = await window.waitForAuthReady();
      if (user) return user;
      const next = encodeURIComponent(location.href);
      location.replace(`index.html?next=${next}`); // ä½ ç™»å…¥é å« index.html
      return null;
    }

    // ============================
    // âœ… æ–°å¢ï¼šå…©ç”¨å¯«å…¥ï¼ˆFunctionå„ªå…ˆï¼Œå¤±æ•—fallbackå‰ç«¯ç›´å¯«ï¼‰
    // ============================
    function isLocalhost(){
      return location.hostname === "localhost" || location.hostname === "127.0.0.1";
    }

    async function addViaFunction(payload){
      const u = auth.currentUser;
      if (!u) throw new Error("Not logged in");

      const token = await u.getIdToken();

      const res = await fetch("/.netlify/functions/addTransaction", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const text = await res.text();
        // æŠŠéŒ¯èª¤å®Œæ•´ä¿ç•™åœ¨ consoleï¼Œæ–¹ä¾¿ä½  debug
        console.error("Function error status:", res.status, "body:", text);
        throw new Error(text || `Function failed: ${res.status}`);
      }

      return res.json().catch(() => ({}));
    }

    async function addViaClientFirestore(payload){
      const u = auth.currentUser;
      if (!u) throw new Error("Not logged in");

      await addDoc(
        collection(db, "users", u.uid, "transactions"),
        { ...payload, createdAt: serverTimestamp() }
      );
    }

    async function writeTransaction(payload, { prefer = "function" } = {}){
      // prefer: "function" æˆ– "client"
      const u = auth.currentUser;
      if (!u) throw new Error("Not logged in");

      const tryFunctionFirst = (prefer === "function") && !isLocalhost();

      if (tryFunctionFirst) {
        try {
          await addViaFunction(payload);
          return { via: "function" };
        } catch (e) {
          console.warn("Function write failed; fallback to client Firestore:", e);
          await addViaClientFirestore(payload);
          return { via: "client_fallback" };
        }
      } else {
        try {
          await addViaClientFirestore(payload);
          return { via: "client" };
        } catch (e) {
          console.warn("Client write failed; fallback to function:", e);
          await addViaFunction(payload);
          return { via: "function_fallback" };
        }
      }
    }

    async function saveToFirestore({ redirectAfter = true } = {}){
      console.log("firebaseReady:", !!window.firebaseReady);
      console.log("currentUser:", window.auth?.currentUser?.uid || null);

      const user = await ensureLoginOrRedirect();
      if (!user) return; // å·²è·³è½‰

      const date = dateInput.value || todayYMD();
      const time = nowHHMM();
      const timeSort = timeToMinutesFromHHmm(time);
      const category = (categorySelect.value || "").trim();
      const note = (noteInput.value || "").trim();
      const amount = parseAmount(amountInput.value);

      if(!category){ alert("è«‹é¸æ“‡åˆ†é¡"); return; }
      if(!isFinite(amount) || amount <= 0){ alert("è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡ï¼ˆ> 0ï¼‰"); return; }

      // âœ… æ³¨æ„ï¼špayload ä¸åŒ…å« createdAtï¼ˆFunction ç”±å¾Œç«¯åŠ ï¼›client ç”± addViaClientFirestore åŠ ï¼‰
      const payload = { date, timeSort, type: currentType, amount, category, note };

      // âœ… å…©ç”¨å¯«å…¥ï¼šå„ªå…ˆ Functionï¼Œå¤±æ•—è‡ªå‹• fallback
      const result = await writeTransaction(payload, { prefer: "function" });
      console.log("writeTransaction via:", result.via);

      if(redirectAfter){
        const ym = monthKeyFromDateStr(date);
        location.replace(ym ? `month.html?m=${ym}` : "month.html");
      }
    }

    saveBtn.addEventListener("click", async () => {
      saveBtn.disabled = true;
      try {
        await saveToFirestore({ redirectAfter: true });
      } catch (e) {
        console.error("save failed:", e);
        alert(`å„²å­˜å¤±æ•—: ${e.message || e}`);
        saveBtn.disabled = false;
      }
    });

    // âœ… æ·å¾‘è‡ªå‹•å„²å­˜ï¼šç­‰ UI & auth éƒ½ ready å¾Œæ‰åšï¼ˆåŸæœ‰åŠŸèƒ½ä¿ç•™ï¼‰
    if (autoSave) {
      const ok = qsAmount && qsCategory;
      if (ok) {
        try {
          await saveToFirestore({ redirectAfter: true });
        } catch (e) {
          console.error("autosave failed:", e);
          alert(`è‡ªå‹•å„²å­˜å¤±æ•—: ${e.message || e}`);
        }
      }
    }
  </script>

</body>
</html>