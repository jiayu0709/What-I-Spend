<!doctype html>
<html lang="zh-Hant">
<head>
  <link rel="stylesheet" href="theme.css">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>編輯明細</title>
  <style>
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--app-bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    }
    .app{min-height:100vh;padding-bottom:18px}
    .page{max-width:520px;margin:0 auto;padding:18px var(--page-padding) 28px}
    .nav{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 0 6px;
    }
    .back{
      text-decoration:none;
  color: var(--accent-text);
  font-weight:800;
    }
    .title{
      font-size:34px;font-weight:900;margin:6px 0 12px;letter-spacing:-.4px;
    }
    .card{background:var(--card-bg);border-radius:var(--radius);padding:16px}
    .field{display:grid;gap:8px;margin-top:14px}
    .field:first-child{margin-top:0}
    .label{font-size:14px;font-weight:900;color:var(--secondary)}

     /* ✅ 統一所有白框（input / select / date / time）高度，並修 iOS 溢出 */
    .input,
    input,
    select {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;

    height: 52px;              /* ✅ 關鍵：統一高度 */
    padding: 0 12px;           /* ✅ 垂直置中靠 line-height，不用上下 padding */
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,0.12);
    background: #fff;
    font-size: 16px;
    line-height: 52px;         /* ✅ input 文字垂直置中 */
    }

    /* iOS 的 date/time/select 需要特殊處理 */
    input[type="date"],
    input[type="time"],
    select {
    display: block;
    appearance: none;
    -webkit-appearance: none;
    }

    /* select 用 line-height: normal，避免 iOS 裁字 */
    select {
    line-height: normal;
    padding-top: 0;
    padding-bottom: 0;
    }

    /* 防止 grid/flex 子元素撐爆 */
    .field {
    width: 100%;
    min-width: 0;
    }

   .btnbar{margin-top:14px;display:grid;gap:10px}

  /* ✅ 按鈕跟卡片同圓角、不要任何外框直角線 */
  .btn{
    width:100%;
    padding:14px 16px;
    border:0;                 /* ✅ 不要框線 */
    outline:0;
    border-radius: var(--radius);   /* ✅ 跟卡片同一個圓角變數 */
    background: var(--btn-secondary-bg, var(--card-bg));
    color: var(--btn-secondary-text, var(--accent-text));
    font-size:18px;
    font-weight:900;
    cursor:pointer;
    appearance:none;
    -webkit-appearance:none;
  }

  /* ✅ 主按鈕（儲存） */
  .btn.primary{
    background: var(--btn-primary-bg, var(--accent-text));
    color: var(--btn-primary-text, #fff);
  }

  /* ✅ iOS 按壓效果 */
  .btn:active{
    opacity:.7;
    transform:scale(.98);
  }
    /* ===== iOS-style Button Interaction ===== */

    /* 關閉瀏覽器預設點擊高亮（超重要） */
    button,
    a {
    -webkit-tap-highlight-color: transparent;
    }

    /* 所有按鈕的共同行為 */
    .btn,
    .back {
    transition:
        background-color 0.15s ease,
        opacity 0.15s ease,
        transform 0.1s ease;
    user-select: none;
    }

    /* iOS 按下瞬間 */
    .btn:active,
    .back:active {
    opacity: 0.6;              /* iOS 最像的反黑感 */
    transform: scale(0.98);    /* 微縮，像原生 */
    }

    /* primary 按鈕按下（藍色） */
    .btn.primary:active {
    opacity: 0.75;             /* primary 不要太黑 */
    }

    /* 防止長按選字 */
    .btn,
    .back {
    -webkit-user-select: none;
    user-select: none;
    }
  </style>
</head>
<body>
  <div class="app">
    <main class="page">
      <div class="nav">
        <a class="back" id="backLink" href="month.html">‹ 返回</a>
        <div></div>
      </div>

      <div class="title">編輯明細</div>

      <div class="card">
        <div class="field">
          <div class="label">日期</div>
          <input class="input" type="date" id="date" />
        </div>

        <div class="field">
          <div class="label">時間</div>
          <input class="input" type="time" id="time" />
        </div>

        <div class="field">
          <div class="label">分類</div>
          <input class="input" type="text" id="category" placeholder="例如：飲料" />
        </div>

        <!-- ✅ 已移除「類型」欄位，金額改為單欄 -->
        <div class="field">
          <div class="label">金額</div>
          <input class="input" type="number" id="amount" placeholder="例如：200" />
        </div>

        <div class="field">
          <div class="label">備註</div>
          <input class="input" type="text" id="note" placeholder="（可空）" />
        </div>
      </div>

      <div class="btnbar">
        <button class="btn primary" type="button" onclick="save()">儲存</button>
        <button class="btn" type="button" onclick="removeTx()">刪除</button>
      </div>

    </main>
  </div>
  
  <script type="module">
  import { doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { auth, db } from "./firebase-config.js";

  // 給非-module 的 <script> 呼叫
  window.saveToCloud = async (id, data) => {
    const user = await window.requireAuth();
    if (!user) throw new Error("Not logged in");

    const ref = doc(db, "users", user.uid, "transactions", id);
    await updateDoc(ref, {
      date: data.date,
      time: data.time,
      category: data.category,
      note: data.note,
      amount: Number(String(data.amount).replace(/,/g, "")),
    });
  };

  window.deleteFromCloud = async (id) => {
    const user = await window.requireAuth();
    if (!user) throw new Error("Not logged in");

    const ref = doc(db, "users", user.uid, "transactions", id);
    await deleteDoc(ref);
  };
</script>

  <script>
    const qs = new URLSearchParams(location.search);
    const id = qs.get("id") || "tx-unknown";

    // 回上一頁（可從 ref 帶回去）
    const ref = qs.get("ref") || "month.html";
    document.getElementById("backLink").href = ref;

    function init(){
      const saved = localStorage.getItem("tx:"+id);
      let data = null;

      if(saved){
        try{ data = JSON.parse(saved); }catch(e){}
      }else{
        // 沒存過就用 query 當初始值
        data = {
          id,
          date: qs.get("date") || "",
          time: qs.get("time") || "",
          category: qs.get("cat") || "",
          note: qs.get("note") || "",
          amount: qs.get("amount") || ""
        };
      }

      document.getElementById("date").value = data.date || "";
      document.getElementById("time").value = data.time || "";
      document.getElementById("category").value = data.category || "";
      document.getElementById("note").value = data.note || "";
      document.getElementById("amount").value = data.amount || "";
    }

    async function save(){
      const data = {
        id,
        date: document.getElementById("date").value,
        time: document.getElementById("time").value,
        category: document.getElementById("category").value.trim(),
        note: document.getElementById("note").value.trim(),
        amount: document.getElementById("amount").value
      };

      const amt = Number(String(data.amount).replace(/,/g,""));
      if(!isFinite(amt) || amt <= 0){
        alert("請輸入正確金額（> 0）");
        return;
      }

      // 先存本機（保留你原本邏輯，避免你覺得功能被拿掉）
      localStorage.setItem("tx:"+id, JSON.stringify(data));

      try {
        // ✅ 存雲端（真正讓 month.html 變更）
        await window.saveToCloud(id, data);
      } catch (e) {
        console.error("saveToCloud failed:", e);
        alert("儲存失敗（雲端）：" + (e.message || e));
        return;
      }

      location.href = ref;
    }

    async function removeTx(){
  // 先刪本機（保留原本行為）
  localStorage.removeItem("tx:"+id);
  localStorage.setItem("tx:deleted:"+id, "1");

  try {
      // ✅ 刪雲端
      await window.deleteFromCloud(id);
    } catch (e) {
      console.error("deleteFromCloud failed:", e);
      alert("刪除失敗（雲端）：" + (e.message || e));
      return;
    }

    location.href = ref;
  }

    init();
  </script>
  <script>
  document.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', e => {
      const href = link.getAttribute('href');
      if (!href || href.startsWith('#')) return;

      e.preventDefault();

      const page = document.querySelector('.page');
      if (!page) {
        location.href = href;
        return;
      }

      page.classList.add('leaving');

      setTimeout(() => {
        location.href = href;
      }, 200); // ⏱ 要和 CSS page-leave 時間一致
    });
  });
</script>
</body>
</html>