<script type="module">
  import { auth } from "./firebase-config.js";
  import {
    GoogleAuthProvider,
    signInWithRedirect,
    getRedirectResult,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const loginBtn = document.getElementById("loginBtn");
  const loader = document.getElementById("loader");
  const provider = new GoogleAuthProvider();

  await window.firebaseReady;

  // 先處理 redirect 回來的結果（讓 Firebase 把 state/code 吃掉）
  try { await getRedirectResult(auth); } catch (e) { console.warn(e); }

  onAuthStateChanged(auth, (user) => {
    console.log("auth state:", user?.uid || null);
    if (user) location.replace("month.html");
    else {
      loginBtn.style.display = "flex";
      loader.style.display = "none";
    }
  });

  loginBtn.addEventListener("click", async () => {
    loginBtn.style.display = "none";
    loader.style.display = "block";
    await signInWithRedirect(auth, provider);
  });
</script>