<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>What I Spend</title>

  <style>
    :root{
      --app-bg:#f2ede9;
      --card-bg:rgba(255,255,255,0.72);
      --text:#3c3c3c;
      --secondary:#8e8e93;
      --accent:#d61c68;
      --radius:22px;
      --line:rgba(0,0,0,0.08);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background:
        radial-gradient(1200px 700px at 50% -200px, rgba(255,255,255,0.85), transparent 60%),
        var(--app-bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      display:grid;
      place-items:center;
      padding: env(safe-area-inset-top) 18px env(safe-area-inset-bottom);
    }

    .card{
      width:min(520px, 100%);
      background:var(--card-bg);
      border-radius:var(--radius);
      border:1px solid var(--line);
      padding:18px 16px;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: 0 18px 40px rgba(0,0,0,0.10);
    }

    .hero{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .logo{
      font-size:44px;
      width:56px;height:56px;
      border-radius:18px;
      background:rgba(255,255,255,0.6);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .title{
      font-size:30px;
      font-weight:900;
      letter-spacing:-.5px;
      margin:6px 0 4px;
    }
    .subtitle{
      margin:0;
      color:var(--secondary);
      font-weight:800;
      line-height:1.4;
      font-size:14px;
    }

    .section{margin-top:14px}
    .step{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:12px;
      border-radius:16px;
      background:rgba(255,255,255,0.6);
      border:1px solid var(--line);
    }
    .badge{
      width:26px;height:26px;
      border-radius:9px;
      background:rgba(0,0,0,0.06);
      display:grid;place-items:center;
      font-weight:900;
      font-size:13px;
      flex:0 0 auto;
    }
    .step .t{ font-weight:900; font-size:14px; }
    .step .d{
      font-weight:800;
      color:var(--secondary);
      font-size:12px;
      margin-top:2px;
      line-height:1.4;
    }

    .actions{
      margin-top:14px;
      display:grid;
      gap:10px;
    }
    .btn{
      width:100%;
      padding:14px 16px;
      border-radius:var(--radius);
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.6);
      color:var(--text);
      text-decoration:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .btn.primary{
      background:var(--accent);
      color:#fff;
      border:0;
    }
    .btn:active{ transform:scale(.99); opacity:.85 }

    .note{
      margin-top:10px;
      font-size:12px;
      font-weight:800;
      color:var(--secondary);
      line-height:1.5;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom) + 18px);
      transform:translateX(-50%);
      background:rgba(0,0,0,0.82);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-size:13px;
      font-weight:800;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
    }
    .toast.show{ opacity:1 }
  </style>
</head>

<body>

<div class="card">
  <div class="hero">
    <div>
      <div class="title">é–‹å§‹ä½¿ç”¨</div>
      <p class="subtitle">
        ç‚ºäº†é †åˆ©ç™»å…¥ï¼ˆGoogle / é›™é‡é©—è­‰ï¼‰<br>
        è«‹ä½¿ç”¨ <b>Safari</b> é–‹å•Ÿ
      </p>
    </div>
    <div class="logo">ğŸ’°</div>
  </div>

  <div class="section">
    <div class="step">
      <div class="badge">1</div>
      <div>
        <div class="t">é»å³ä¸Šè§’ã€Œâ‹¯ / åˆ†äº«ã€</div>
        <div class="d">LINEã€IGã€FB å…§å»ºç€è¦½å™¨éƒ½å¯ä»¥</div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="step">
      <div class="badge">2</div>
      <div>
        <div class="t">é¸æ“‡ã€Œåœ¨ Safari ä¸­é–‹å•Ÿã€</div>
        <div class="d">é¿å… Google ç™»å…¥è¢«ç³»çµ±é˜»æ“‹</div>
      </div>
    </div>
  </div>

  <div class="actions">
    <button class="btn primary" id="copyBtn">ğŸ“‹ è¤‡è£½ Safari ç™»å…¥é€£çµ</button>
    <a class="btn" href="login.html">æˆ‘å·²åœ¨ Safariï¼Œå‰å¾€ç™»å…¥ â†’</a>
  </div>

  <div class="note">
    è‹¥ä½ æ˜¯å¾ã€ŒåŠ å…¥ä¸»ç•«é¢ã€é–‹å•Ÿï¼Œè«‹æ”¹ç”¨ Safari ç™»å…¥ä¸€æ¬¡å³å¯ã€‚
  </div>
</div>

<div class="toast" id="toast">å·²è¤‡è£½é€£çµï¼Œè«‹è²¼åˆ° Safari é–‹å•Ÿ âœ…</div>

<script>
  // ===== copy safari login url =====
  const loginUrl = new URL("login.html", location.href).toString();
  const copyBtn = document.getElementById("copyBtn");
  const toast = document.getElementById("toast");

  copyBtn.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(loginUrl);
    }catch{
      const t = document.createElement("textarea");
      t.value = loginUrl;
      document.body.appendChild(t);
      t.select();
      document.execCommand("copy");
      document.body.removeChild(t);
    }
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2000);
  });
</script>

<script type="module">
  // ===== åˆ¤æ–·ï¼šåªæœ‰ã€ŒçœŸæ­£ Safari + éä¸»ç•«é¢ã€æ‰è‡ªå‹•é›¢é–‹å°è¦½é  =====
  function isRealSafari(){
    const ua = navigator.userAgent || "";
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    return (
      isIOS &&
      /Safari/i.test(ua) &&
      !/CriOS|FxiOS|EdgiOS|OPiOS|DuckDuckGo|Line|FBAN|FBAV|Instagram/i.test(ua)
    );
  }
  const isStandalone =
    window.navigator.standalone === true ||
    window.matchMedia?.("(display-mode: standalone)")?.matches;

    // âœ… å¾ä¸»ç•«é¢ icon é–‹å•Ÿï¼ˆstandaloneï¼‰â†’ ç›´æ¥å»ç™»å…¥é 
  if (isStandalone) {
    location.replace("login.html");
  }

  if (isRealSafari() && !isStandalone) {
    // âœ… é˜²æ­¢å¡ä½ï¼šå¦‚æœ firebaseReady ä¸€ç›´æ²’èµ·ä¾†ï¼Œç›´æ¥å» a2hs
    const fallback = setTimeout(() => {
      location.replace("a2hs.html");
    }, 1200);

    try{
      await window.firebaseReady;
      clearTimeout(fallback);

      const user = await window.waitForAuthReady?.();

      // âœ… é‡é»æ”¹é€™è£¡ï¼šSafari å…§ã€Œæœªç™»å…¥ã€ä¹Ÿå…ˆå» a2hs
      if (!user) {
        location.replace("a2hs.html");
      } else {
        try{
          const { db } = await import("./firebase-config.js");
          const { doc, getDoc, setDoc, serverTimestamp } =
            await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

          const userRef = doc(db, "users", user.uid);
          const snap = await getDoc(userRef);

          if (!snap.exists()) {
            await setDoc(userRef, {
              createdAt: serverTimestamp(),
              a2hsDone: false,
            });
            location.replace("a2hs.html");
          } else {
            const data = snap.data() || {};
            if (data.a2hsDone === false) {
              location.replace("a2hs.html");
            } else {
              location.replace("month.html");
            }
          }
        }catch(e){
          console.error("index route failed:", e);
          location.replace("month.html");
        }
      }
    }catch(e){
      console.error("firebaseReady failed:", e);
      // ä»»ä½•éŒ¯èª¤éƒ½ä¸è¦åœåœ¨å°è¦½é 
      location.replace("a2hs.html");
    }
  }
</script>
<!-- ä½ åŸæœ¬çš„ app.jsï¼ˆä¿ç•™ï¼‰ -->
<script type="module" src="app.js"></script>

</body>
</html>