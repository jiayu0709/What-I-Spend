<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">

  <!-- âœ… å¥—ç”¨å…¨ç«™ themeï¼ˆä¸è¦†è“‹ã€ä¸æ”¹ theme.cssï¼‰ -->
  <link rel="stylesheet" href="theme.css">

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="What I Spend">

  <!-- Android -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#f2ede9">

  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>What I Spend</title>

  <style>
    /* âœ… åªåšã€Œç‰ˆé¢ã€èˆ‡ã€Œè¦–è¦ºã€ï¼šä¸æ”¹åŠŸèƒ½ã€ä¸æ”¹ JS
       âœ… å…¨éƒ¨ç”¨ theme.css çš„è®Šæ•¸ï¼Œä¸å»è¦†è“‹ theme.css
    */

    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      background: var(--app-bg, #f2ede9);
      color: var(--text, #3c3c3c);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
    }

    .app{
      min-height:100vh;
      display:flex;
      justify-content:center;
    }

    .page{
      width:100%;
      max-width:520px;
      padding:18px var(--page-padding,16px) 28px;
    }

    .nav-title{
      font-size:42px;
      font-weight:800;
      margin:10px 0 14px;
      letter-spacing:-.5px;
    }

    /* Card */
    .card{
      background: var(--card-bg, rgba(255,255,255,0.72));
      border-radius: var(--radius, 22px);
      padding:16px;
    }

    .hero{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    .title{
      font-size:30px;
      font-weight:900;
      letter-spacing:-.5px;
      margin:0 0 6px;
    }

    .subtitle{
      margin:0;
      color: var(--secondary, #8e8e93);
      font-weight:800;
      line-height:1.5;
      font-size:14px;
    }

    .logo{
      width:56px;
      height:56px;
      border-radius:18px;
      display:grid;
      place-items:center;
      font-size:34px;
      background: rgba(255,255,255,0.55);
      flex:0 0 auto;
    }

    /* Feature list (åƒä½ æˆªåœ–çš„ä¸‰æ®µå¡ç‰‡) */
    .section{ margin-top:16px; }

    .feature{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 14px;
      border-radius: var(--radius, 22px);
      background: rgba(255,255,255,0.55);
    }
    .feature + .feature{ margin-top:12px; }

    .f-ic{
      width:34px;height:34px;
      border-radius:12px;
      display:grid;place-items:center;
      background: rgba(0,0,0,0.06);
      flex:0 0 auto;
      font-size:18px;
    }
    .f-t{
      font-weight:900;
      font-size:16px;
      letter-spacing:-.2px;
    }
    .f-d{
      margin-top:2px;
      font-weight:800;
      color: var(--secondary, #8e8e93);
      font-size:13px;
      line-height:1.4;
    }

    /* Steps (ä¿ç•™ä½ åŸæœ¬å…©æ­¥é©Ÿå…§å®¹ï¼Œä½†åšæˆä¸€è‡´å¡ç‰‡æ¨£å¼) */
    .steps{
      margin-top:12px;
      display:grid;
      gap:12px;
    }

    .step{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:12px;
      border-radius: 18px;
      background: rgba(255,255,255,0.55);
    }

    .badge{
      width:26px;height:26px;
      border-radius:10px;
      background: rgba(0,0,0,0.06);
      display:grid;place-items:center;
      font-weight:900;
      font-size:13px;
      flex:0 0 auto;
    }

    .step .t{ font-weight:900; font-size:14px; }
    .step .d{
      font-weight:800;
      color: var(--secondary, #8e8e93);
      font-size:12px;
      margin-top:2px;
      line-height:1.4;
    }

    /* Action button: è®Šæˆä½  app å…§å¸¸è¦‹çš„å¤§æŒ‰éˆ•é¢¨æ ¼ */
    .actions{
      margin-top:14px;
      display:grid;
      gap:10px;
    }

    .btn{
      width:100%;
      padding:14px 16px;
      border-radius: var(--radius, 22px);
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      border:0;
      background: var(--card-bg, rgba(255,255,255,0.72));
      color: var(--accent-text, var(--text, #3c3c3c));
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }

    .btn.primary{
      background: var(--accent, #d61c68);
      color:#fff;
    }

    .btn:active{ transform:scale(.99); opacity:.85; }

    /* Toast ä¿ç•™ä½ åŸæœ¬å®šä½èˆ‡è¡Œç‚º */
    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom) + 18px);
      transform:translateX(-50%);
      background:rgba(0,0,0,0.82);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-size:13px;
      font-weight:800;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
      z-index:9999;
    }
    .toast.show{ opacity:1; }
  </style>
</head>

<body>
  <div class="app">
    <main class="page">
      <div class="nav-title">é–‹å§‹ä½¿ç”¨</div>

      <!-- Hero card -->
      <div class="card">
        <div class="hero">
          <div>
            <div class="title">é–‹å§‹ä½¿ç”¨</div>
            <p class="subtitle">
              æ­¡è¿ä½¿ç”¨ What I Spend<br>
              è«‹ä½¿ç”¨ <b>Safari</b> é–‹å•Ÿ
            </p>
          </div>
          <div class="logo">ğŸ’°</div>
        </div>

        <!-- ä½ å–œæ­¡çš„ã€ŒåŠŸèƒ½äº®é»ã€å¡ç‰‡é¢¨æ ¼ï¼ˆç´”è¦–è¦ºï¼Œä¸å½±éŸ¿åŠŸèƒ½ï¼‰ -->
        <div class="section">
          <div class="feature">
            <div class="f-ic">âœ…</div>
            <div>
              <div class="f-t">æ·å¾‘ä¸€éµè¨˜å¸³</div>
              <div class="f-d">ä¸ç”¨é–‹ appï¼Œä¹Ÿèƒ½å¿«é€Ÿè¨˜å¸³</div>
            </div>
          </div>

          <div class="feature">
            <div class="f-ic">â˜ï¸</div>
            <div>
              <div class="f-t">è‡ªå‹•åŒæ­¥é›²ç«¯</div>
              <div class="f-d">æ‰‹æ©Ÿ / é›»è…¦éƒ½èƒ½æŸ¥çœ‹èˆ‡ç·¨è¼¯</div>
            </div>
          </div>

          <div class="feature">
            <div class="f-ic">ğŸ”’</div>
            <div>
              <div class="f-t">æ¯å€‹äººç¨ç«‹å¸³æˆ¶</div>
              <div class="f-d">ç™»å…¥å¾Œæ‰€æœ‰è£ç½®éƒ½èƒ½çœ‹åˆ°è¨˜å¸³</div>
            </div>
          </div>
        </div>

        <!-- åŸæœ¬çš„å…©æ­¥é©ŸæŒ‡å¼•ï¼ˆæ–‡å­—ä¸æ”¹ï¼Œå‘ˆç¾æ–¹å¼è®Šä¸€è‡´ï¼‰ -->
        <div class="section">
          <div class="steps">
            <div class="step">
              <div class="badge">1</div>
              <div>
                <div class="t">é»å³ä¸Šè§’æˆ–å³ä¸‹è§’ã€Œâ‹¯ / åˆ†äº«ã€</div>
                <div class="d">LINEã€IGã€FB å…§å»ºç€è¦½å™¨éƒ½å¯ä»¥</div>
              </div>
            </div>

            <div class="step">
              <div class="badge">2</div>
              <div>
                <div class="t">é¸æ“‡ã€Œåœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿã€</div>
                <div class="d">é¿å… Google ç™»å…¥è¢«ç³»çµ±é˜»æ“‹</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actionsï¼šä¿ç•™ copyBtn id èˆ‡åŠŸèƒ½ -->
        <div class="actions">
          <button class="btn primary" id="copyBtn">ğŸ“‹ è¤‡è£½ Safari ç™»å…¥é€£çµ</button>
        </div>
      </div>
    </main>
  </div>

  <div class="toast" id="toast">å·²è¤‡è£½é€£çµï¼Œè«‹è²¼åˆ° Safari é–‹å•Ÿ âœ…</div>

  <script>
    // ===== copy safari login url =====
    const loginUrl = new URL("login.html", location.href).toString();
    const copyBtn = document.getElementById("copyBtn");
    const toast = document.getElementById("toast");

    copyBtn.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(loginUrl);
      }catch{
        const t = document.createElement("textarea");
        t.value = loginUrl;
        document.body.appendChild(t);
        t.select();
        document.execCommand("copy");
        document.body.removeChild(t);
      }
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2000);
    });
  </script>

  <script type="module">
    // ===== åˆ¤æ–·ï¼šåªæœ‰ã€ŒçœŸæ­£ Safari + éä¸»ç•«é¢ã€æ‰è‡ªå‹•é›¢é–‹å°è¦½é  =====
    function isRealSafari(){
      const ua = navigator.userAgent || "";
      const isIOS = /iPhone|iPad|iPod/i.test(ua);
      return (
        isIOS &&
        /Safari/i.test(ua) &&
        !/CriOS|FxiOS|EdgiOS|OPiOS|DuckDuckGo|Line|FBAN|FBAV|Instagram/i.test(ua)
      );
    }
    const isStandalone =
      window.navigator.standalone === true ||
      window.matchMedia?.("(display-mode: standalone)")?.matches;

      // âœ… å¾ä¸»ç•«é¢ icon é–‹å•Ÿï¼ˆstandaloneï¼‰â†’ ç›´æ¥å»ç™»å…¥é 
    if (isStandalone) {
      location.replace("login.html");
    }

    if (isRealSafari() && !isStandalone) {
      // âœ… é˜²æ­¢å¡ä½ï¼šå¦‚æœ firebaseReady ä¸€ç›´æ²’èµ·ä¾†ï¼Œç›´æ¥å» a2hs
      const fallback = setTimeout(() => {
        location.replace("a2hs.html");
      }, 1200);

      try{
        await window.firebaseReady;
        clearTimeout(fallback);

        const user = await window.waitForAuthReady?.();

        // âœ… é‡é»æ”¹é€™è£¡ï¼šSafari å…§ã€Œæœªç™»å…¥ã€ä¹Ÿå…ˆå» a2hs
        if (!user) {
          location.replace("a2hs.html");
        } else {
          try{
            const { db } = await import("./firebase-config.js");
            const { doc, getDoc, setDoc, serverTimestamp } =
              await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);

            if (!snap.exists()) {
              await setDoc(userRef, {
                createdAt: serverTimestamp(),
                a2hsDone: false,
              });
              location.replace("a2hs.html");
            } else {
              const data = snap.data() || {};
              if (data.a2hsDone === false) {
                location.replace("a2hs.html");
              } else {
                location.replace("month.html");
              }
            }
          }catch(e){
            console.error("index route failed:", e);
            location.replace("month.html");
          }
        }
      }catch(e){
        console.error("firebaseReady failed:", e);
        // ä»»ä½•éŒ¯èª¤éƒ½ä¸è¦åœåœ¨å°è¦½é 
        location.replace("a2hs.html");
      }
    }
  </script>

  <!-- ä½ åŸæœ¬çš„ app.jsï¼ˆä¿ç•™ï¼‰ -->
  <script type="module" src="app.js"></script>
</body>
</html>