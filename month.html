<!doctype html>
<html lang="zh-Hant">
<head>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="theme.css">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="What I Spend">

  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>

  <title>本月</title>

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--app-bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",
                   Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    }

    .app{min-height:100vh;padding-bottom:var(--tab-height)}
    .page{max-width:520px;margin:0 auto;padding:18px var(--page-padding,16px) 28px}

    .nav-title{font-size:42px;font-weight:800;margin:10px 0 14px}

    /* 月份切換器 */
    .monthbar{
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    .m-btn{
      background:none;border:0;
      font-size:20px;
      font-weight:900;
      color:var(--accent);
    }
    .m-title{font-weight:900}

    .section{margin-top:18px}
    .card{background:var(--card-bg);border-radius:var(--radius);padding:16px}

    .rows{display:grid;gap:10px;font-size:18px}
    .row{display:flex;justify-content:space-between}
    .v.green{color:var(--green);font-weight:800}
    .v.red{color:var(--red);font-weight:800}

    .day-header{
      display:flex;
      justify-content:space-between;
      font-weight:800;
      color:var(--secondary);
      margin:14px 0 8px;
    }
    .day-total{font-size:14px;font-weight:900}
    .day-total .v.green{color:var(--green)}
    .day-total .v.red{color:var(--red)}

    .day-card{background:var(--card-bg);border-radius:var(--radius);overflow:hidden}

    .tx{
      display:grid;
      grid-template-columns:1fr auto;
      padding:14px 16px;
      text-decoration:none;
      color:var(--text);
    }
    .cat{font-size:20px;font-weight:700}
    .note{font-size:14px;color:var(--secondary)}
    .amt{font-size:20px;font-weight:800}
    .time{font-size:14px;color:var(--secondary)}

    .divider{height:1px;background:var(--divider);border:0;margin:0}

    .empty{
      margin-top:20px;
      background:rgba(255,255,255,.5);
      border-radius:var(--radius);
      padding:16px;
      text-align:center;
      color:var(--secondary);
      font-weight:800;
    }

    /* Tab bar */
    .tabbar{
      position:fixed;left:0;right:0;bottom:0;
      height:var(--tab-height);
      background:rgba(255,255,255,.65);
      backdrop-filter:blur(18px);
      border-top:1px solid rgba(0,0,0,.08);
      display:flex;justify-content:center;
    }
    .tabbar-inner{
      max-width:520px;width:100%;
      display:grid;
      grid-template-columns:repeat(3,1fr);
      padding:10px 18px 18px;
    }
    .tab{
      text-decoration:none;
      color:var(--secondary);
      display:grid;
      place-items:center;
      font-weight:800;
    }
    .tab.active{color:var(--accent)}
  </style>
</head>

<body>
<div class="app">
  <main class="page">

    <div class="nav-title">本月</div>

    <div class="monthbar">
      <button id="btnPrev" class="m-btn">‹</button>
      <div class="m-title" id="monthLabel"></div>
      <button id="btnNext" class="m-btn">›</button>
    </div>

    <section class="section">
      <div class="card">
        <div class="rows">
          <div class="row">收入 <span id="sum-income" class="v green">0</span></div>
          <div class="row">支出 <span id="sum-expense" class="v red">0</span></div>
          <div class="row">結餘 <span id="sum-balance" class="v red">0</span></div>
        </div>
      </div>
    </section>

    <div id="list-root"></div>

  </main>

  <nav class="tabbar">
    <div class="tabbar-inner">
      <a class="tab" href="add.html">新增</a>
      <a class="tab" href="month.html">本月</a>
      <a class="tab" href="year.html">年度</a>
    </div>
  </nav>
</div>

<!-- 本頁專屬 JS -->
<script>
  const qs = new URLSearchParams(location.search);
  const now = new Date();
  let y = +qs.get('y') || now.getFullYear();
  let m = +qs.get('m') || now.getMonth() + 1;

  const label = document.getElementById('monthLabel');
  label.textContent = `${y} / ${m}`;

  btnPrev.onclick = () => location.href = `month.html?y=${y}&m=${m-1}`;
  btnNext.onclick = () => location.href = `month.html?y=${y}&m=${m+1}`;

  function getTxs(){
    const ids = JSON.parse(localStorage.getItem('tx:index')||'[]');
    return ids.map(id=>JSON.parse(localStorage.getItem('tx:'+id)||'{}'))
      .filter(tx=>tx.date?.startsWith(`${y}-${String(m).padStart(2,'0')}`));
  }

  function render(){
    const root = document.getElementById('list-root');
    root.innerHTML = '';

    const txs = getTxs();
    if(!txs.length){
      root.innerHTML = `<div class="empty">這個月還沒有明細</div>`;
      return;
    }

    let income=0,expense=0;
    const groups={};

    txs.forEach(tx=>{
      const amt=+tx.amount||0;
      if(tx.type==='income') income+=amt;
      else expense+=amt;
      groups[tx.date]=(groups[tx.date]||[]).concat(tx);
    });

    document.getElementById('sum-income').textContent = income;
    document.getElementById('sum-expense').textContent = expense;
    document.getElementById('sum-balance').textContent = income - expense;
    Object.keys(groups).sort().reverse().forEach(date=>{
      let dayNet=0;
      const sec=document.createElement('section');
      sec.className='section';

      const header=document.createElement('div');
      header.className='day-header';
      header.innerHTML=`<span>${date}</span><span class="day-total">總計 <span class="v">${groups[date].reduce((s,t)=>{
        const a=+t.amount||0;
        return s+(t.type==='income'?a:-a);
      },0)}</span></span>`;
      sec.appendChild(header);

      const card=document.createElement('div');
      card.className='day-card';

      groups[date].forEach((tx,i)=>{
        const row=document.createElement('a');
        row.className='tx';
        row.href=`edit.html?id=${tx.id}`;
        row.innerHTML=`<div><div class="cat">${tx.category||''}</div>
                       <div class="note">${tx.note||''}</div></div>
                       <div><div class="amt">${tx.type==='income'?tx.amount:-tx.amount}</div>
                       <div class="time">${tx.time||''}</div></div>`;
        card.appendChild(row);
        if(i<groups[date].length-1) card.appendChild(document.createElement('hr')).className='divider';
      });

      sec.appendChild(card);
      root.appendChild(sec);
    });
  }

  render();
</script>

<!-- 全站共用 JS -->
<script src="app.js"></script>
</body>
</html>