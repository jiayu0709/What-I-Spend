<!doctype html>
<html lang="zh-Hant">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="What I Spend">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æœ¬æœˆ</title>
  <style>
    :root{
      --app-bg:#f3e7e3;
      --card-bg:rgba(0,0,0,0.06);
      --text:#111;
      --secondary:rgba(0,0,0,0.45);
      --divider:rgba(0,0,0,0.10);
      --green:#2e9e4b;
      --red:#d94a4a;
      --accent:#4f55d8;
      --radius:16px;
      --page-padding:16px;
      --tab-height:84px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--app-bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    }
    .app{min-height:100vh;padding-bottom:var(--tab-height)}
    .page{max-width:520px;margin:0 auto;padding:18px var(--page-padding) 28px}
    .nav-title{font-size:42px;font-weight:800;margin:10px 0 14px;letter-spacing:-.5px}
    .section{margin-top:18px}
    .card{background:var(--card-bg);border-radius:var(--radius);padding:16px}
    .rows{display:grid;gap:10px;font-size:18px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .v.green{color:var(--green);font-weight:800}
    .v.red{color:var(--red);font-weight:800}

    .day-header{font-size:18px;font-weight:800;color:var(--secondary);margin:14px 0 8px;padding-top:6px;padding-bottom:2px}
    .day-card{background:var(--card-bg);border-radius:var(--radius);overflow:hidden}

    .tx{
      display:grid;grid-template-columns:1fr auto;gap:12px;
      padding:14px 16px;text-decoration:none;color:var(--text);
      position:relative;
    }

    .cat{font-size:20px;font-weight:700;line-height:1.2}
    .note{margin-top:4px;font-size:14px;color:var(--secondary)}
    .right{text-align:right;display:grid;gap:4px;min-width:90px}
    .amt{font-size:20px;font-weight:800}
    .time{font-size:14px;color:var(--secondary)}
    .divider{height:1px;background:var(--divider);border:0;margin:0}

    .empty{
      margin-top:18px;
      background:rgba(255,255,255,0.5);
      border:1px solid rgba(0,0,0,0.06);
      border-radius:16px;
      padding:14px 16px;
      color:var(--secondary);
      font-weight:800;
    }

    /* ===== Tab bar ===== */
    .tabbar{
      position:fixed;left:0;right:0;bottom:0;height:var(--tab-height);
      background:rgba(255,255,255,0.65);backdrop-filter:blur(18px);
      border-top:1px solid rgba(0,0,0,0.08);
      display:flex;justify-content:center;
    }
    .tabbar-inner{
      max-width:520px;width:100%;
      display:grid;grid-template-columns:repeat(3,1fr);
      padding:10px 18px 18px;gap:6px;align-items:center;
    }
    .tab{
      text-decoration:none;color:var(--secondary);
      display:grid;place-items:center;gap:6px;
      font-weight:800;padding:8px 0;
    }
    .tab .icon{font-size:24px;line-height:1}
    .tab.active{color:var(--accent)}

    /* =================================================
       iOS-style tap feedbackï¼ˆæŒ‰éˆ•/åˆ—è¡¨/Tabï¼‰
       ================================================= */
    a, button, .tx, .tab{
      -webkit-tap-highlight-color: transparent;
    }
    .tx,
    .tab,
    button{
      user-select:none;
      -webkit-user-select:none;
      transition: opacity .15s ease, transform .10s ease, background-color .15s ease;
    }
    .tx:active{ opacity:.6; transform:scale(.995); }
    .tab:active{ opacity:.6; transform:scale(.98); }
    button:active{ opacity:.65; transform:scale(.98); }
    .tx:focus, .tab:focus, button:focus{ outline:none; }
  </style>
</head>
<body>
  <div class="app">
    <main class="page">
      <div class="nav-title">æœ¬æœˆ</div>

      <!-- Summary -->
      <section class="section">
        <div class="card">
          <div class="rows">
            <div class="row"><div>æ”¶å…¥</div><div class="v green" id="sum-income">0</div></div>
            <div class="row"><div>æ”¯å‡º</div><div class="v red" id="sum-expense">0</div></div>
            <div class="row"><div>çµé¤˜</div><div class="v red" id="sum-balance">0</div></div>
          </div>
        </div>
      </section>

      <!-- é€™è£¡æœƒç”± JS ç”Ÿæˆã€Œä¾æ—¥æœŸåˆ†çµ„ã€çš„åˆ—è¡¨ -->
      <div id="list-root"></div>
    </main>

    <!-- Tab Bar -->
    <nav class="tabbar" aria-label="Tab Bar">
      <div class="tabbar-inner">
        <a class="tab" href="add.html"><div class="icon">ï¼‹</div><div>æ–°å¢</div></a>
        <a class="tab active" href="month.html"><div class="icon">â–¦</div><div>æœ¬æœˆ</div></a>
        <a class="tab" href="year.html"><div class="icon">ğŸ“ˆ</div><div>å¹´åº¦</div></a>
      </div>
    </nav>
  </div>

  <script>
    // ===== helpers =====
    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatTime12h(hhmm){
      if(!hhmm) return "";
      const [hStr, mStr] = hhmm.split(":");
      let h = parseInt(hStr,10);
      const m = parseInt(mStr,10);
      const ampm = h >= 12 ? "PM" : "AM";
      h = h % 12; if(h === 0) h = 12;
      return `${h}:${String(m).padStart(2,"0")} ${ampm}`;
    }
    function ymdToDate(ymd){
      // ymd: YYYY-MM-DD
      if(!ymd) return null;
      const [y,m,d] = ymd.split("-").map(n => parseInt(n,10));
      if(!y || !m || !d) return null;
      return new Date(y, m-1, d);
    }
    function formatDayHeader(ymd){
      const dt = ymdToDate(ymd);
      if(!dt) return ymd || "";
      // ex: Wed, 1/7
      const wd = dt.toLocaleDateString("en-US", { weekday:"short" });
      const mm = dt.getMonth() + 1;
      const dd = dt.getDate();
      return `${wd}, ${mm}/${dd}`;
    }
    function parseAmount(v){
      const n = Number(String(v ?? "").replace(/,/g,""));
      return (isFinite(n) ? n : 0);
    }
    function getTxIndex(){
      try{
        const raw = localStorage.getItem("tx:index");
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }
    function readTx(id){
      const raw = localStorage.getItem("tx:"+id);
      if(!raw) return null;
      try{ return JSON.parse(raw); }catch(e){ return null; }
    }
    function isDeleted(id){
      return localStorage.getItem("tx:deleted:"+id) === "1";
    }

    // ===== rendering =====
    function buildTxRow(tx){
      const rawAmt = parseAmount(tx.amount);
      const isIncome = tx.type === "income";
      const signed = isIncome ? rawAmt : -rawAmt;

      const a = document.createElement("a");
      a.className = "tx";
      a.dataset.id = tx.id;

      // è®“ edit.html èƒ½é å¡« + å›ä¾†èƒ½æ›´æ–°
      const params = new URLSearchParams();
      params.set("id", tx.id);
      params.set("ref", "month.html");
      if(tx.date) params.set("date", tx.date);
      if(tx.time) params.set("time", tx.time);
      params.set("type", tx.type || "expense");
      params.set("amount", String(rawAmt));
      params.set("cat", tx.category || "");
      params.set("note", tx.note || "");
      a.href = "edit.html?" + params.toString();

      const left = document.createElement("div");
      const cat = document.createElement("div");
      cat.className = "cat";
      cat.textContent = tx.category || "";
      left.appendChild(cat);

      const noteTxt = (tx.note || "").trim();
      const note = document.createElement("div");
      note.className = "note";
      if(noteTxt){
        note.textContent = noteTxt;
      }else{
        note.style.display = "none";
      }
      left.appendChild(note);

      const right = document.createElement("div");
      right.className = "right";

      const amt = document.createElement("div");
      amt.className = "amt";
      amt.textContent = String(signed);
      amt.style.color = isIncome ? "var(--green)" : "var(--red)";
      right.appendChild(amt);

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = formatTime12h(tx.time || "");
      right.appendChild(time);

      a.appendChild(left);
      a.appendChild(right);

      return a;
    }

    function render(){
      const root = document.getElementById("list-root");
      root.innerHTML = "";

      // è®€å–æ‰€æœ‰æ˜ç´°ï¼ˆä»¥ tx:index ç‚ºæº–ï¼‰
      const ids = getTxIndex().filter(Boolean);

      const txs = [];
      for(const id of ids){
        if(isDeleted(id)) continue;
        const tx = readTx(id);
        if(!tx) continue;
        if(!tx.id) tx.id = id;
        txs.push(tx);
      }

      // ä¾ date desc, time desc æ’åºï¼ˆåŒæ—¥å†æ¯”æ™‚é–“ï¼‰
      txs.sort((a,b) => {
        const da = (a.date || "");
        const db = (b.date || "");
        if(da !== db) return db.localeCompare(da); // YYYY-MM-DD å­—ä¸²å¯ç›´æ¥æ¯”
        const ta = (a.time || "");
        const tb = (b.time || "");
        return tb.localeCompare(ta);
      });

      // è¨ˆç®— summaryï¼ˆç›®å‰ç•«é¢é€™å€‹æœˆï¼šé€™è£¡å…ˆç®—ã€Œå…¨éƒ¨ tx:indexã€ï¼›ä½ ä¹‹å¾Œå¯åŠ æœˆä»½éæ¿¾ï¼‰
      let income = 0, expense = 0;
      for(const tx of txs){
        const amt = parseAmount(tx.amount);
        if(tx.type === "income") income += amt;
        else expense += amt;
      }
      const balance = income - expense;

      const incomeEl = document.getElementById("sum-income");
      const expenseEl = document.getElementById("sum-expense");
      const balEl = document.getElementById("sum-balance");
      if(incomeEl) incomeEl.textContent = String(income);
      if(expenseEl) expenseEl.textContent = String(expense);
      if(balEl){
        balEl.textContent = String(balance);
        balEl.classList.remove("green","red");
        balEl.classList.add(balance >= 0 ? "green" : "red");
      }

      if(txs.length === 0){
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "ç›®å‰é‚„æ²’æœ‰æ˜ç´°ï¼Œé»ã€Œæ–°å¢ã€é–‹å§‹è¨˜å¸³å§ï¼";
        root.appendChild(empty);
        return;
      }

      // ä¾æ—¥æœŸåˆ†çµ„
      const groups = new Map(); // date -> tx[]
      for(const tx of txs){
        const key = tx.date || "unknown";
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(tx);
      }

      // ä¾æ—¥æœŸæ’åºè¼¸å‡º
      const dates = Array.from(groups.keys()).sort((a,b) => b.localeCompare(a));
      for(const dateKey of dates){
        const section = document.createElement("section");
        section.className = "section";

        const header = document.createElement("div");
        header.className = "day-header";
        header.textContent = formatDayHeader(dateKey);
        section.appendChild(header);

        const card = document.createElement("div");
        card.className = "day-card";

        const list = groups.get(dateKey);
        list.forEach((tx, idx) => {
          card.appendChild(buildTxRow(tx));
          if(idx !== list.length - 1){
            const hr = document.createElement("hr");
            hr.className = "divider";
            card.appendChild(hr);
          }
        });

        section.appendChild(card);
        root.appendChild(section);
      }
    }

    // é€²é é¢å°±æ¸²æŸ“ï¼ˆå¾ add/edit å›ä¾†æœƒç«‹åˆ»åæ˜ ï¼‰
    render();
  </script>
</body>
</html>