<!doctype html>
<html lang="zh-Hant">
<head>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="theme.css">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="What I Spend">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>本月</title>
  <style>
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--app-bg, #f2ede9);color:var(--text, #3c3c3c);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    }
    :root {
      --app-bg: #f2ede9;
      --card-bg: #ffffff;
      --text: #3c3c3c;
      --secondary: #8e8e93;
      --green: #34c759;
      --red: #ff3b30;
      --divider: #e5e5ea;
      --radius: 16px;
      --tab-height: 80px;
    }
    .app{min-height:100vh;padding-bottom:var(--tab-height)}
    .page{max-width:520px;margin:0 auto;padding:18px var(--page-padding, 16px) 28px}

    .nav-title{font-size:42px;font-weight:800;margin:10px 0 14px;letter-spacing:-.5px}

    .monthbar{
      margin-top:8px;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .monthbar .m-btn{
      border:0;
      background: transparent;
      padding:10px 12px;
      border-radius: 12px;
      font-weight:900;
      color: var(--accent-text, #007aff);
      cursor:pointer;
      appearance:none;
      -webkit-appearance:none;
    }
    .monthbar .m-title{
      font-weight:900;
      letter-spacing:-.2px;
      color: var(--text);
      white-space:nowrap;
    }
    .monthbar .m-title .bracket{
      color: var(--secondary);
      font-weight:900;
    }

    .section{margin-top:18px}
    .card{background:var(--card-bg);border-radius:var(--radius);padding:16px}
    .rows{display:grid;gap:10px;font-size:18px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .v.green{color:var(--green);font-weight:800}
    .v.red{color:var(--red);font-weight:800}

    .day-header{
      display:flex;
      align-items:center;
      justify-content:space-between;

      font-size:18px;
      font-weight:800;
      color:var(--secondary);

      margin:14px 0 8px;
      padding-top:6px;
      padding-bottom:2px;
      gap:12px;
    }
    .day-total{
      font-weight:900;
      color:var(--secondary);
      white-space:nowrap;
      font-size: 14px;
    }
    .day-total .v{
      font-weight:900;
      font-size: 14px;
    }
    .day-total .v.green{ color:var(--green); }
    .day-total .v.red{ color:var(--red); }

    .day-card{background:var(--card-bg);border-radius:var(--radius);overflow:hidden}

    .tx{
      display:grid;grid-template-columns:1fr auto;gap:12px;
      padding:14px 16px;text-decoration:none;color:var(--text);
      position:relative;
    }

    .cat{font-size:20px;font-weight:700;line-height:1.2}
    .note{margin-top:4px;font-size:14px;color:var(--secondary)}
    .right{text-align:right;display:grid;gap:4px;min-width:90px}
    .amt{font-size:20px;font-weight:800}
    .time{font-size:14px;color:var(--secondary)}
    .divider{height:1px;background:var(--divider);border:0;margin:0}

    .empty{
      margin-top:18px;
      background:rgba(255,255,255,0.5);
      border:1px solid rgba(0,0,0,0.06);
      border-radius:var(--radius);
      padding:14px 16px;
      color:var(--secondary);
      font-weight:800;
    }

    /* Tabbar CSS */
    .tabbar {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: var(--tab-height); background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: center;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .tabbar-inner {
      width: 100%; max-width: 520px; display: grid; grid-template-columns: 1fr 1fr 1fr;
    }
    .tab {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-decoration: none; color: #999; font-size: 10px; font-weight: 600; gap: 4px;
    }
    .tab.active { color: #007aff; }
    .tab .icon { font-size: 24px; line-height: 1; margin-bottom: 2px; }
  </style>
</head>
<body>
  <div class="app">
    <main class="page">
      <div class="nav-title">本月</div>

      <div class="monthbar" aria-label="月份切換">
        <button class="m-btn" type="button" id="btnPrev" aria-label="上一月">&lt;</button>
        <div class="m-title">
          <span id="monthLabel">Loading...</span>
        </div>
        <button class="m-btn" type="button" id="btnNext" aria-label="下一月">&gt;</button>
      </div>

      <section class="section">
        <div class="card">
          <div class="rows">
            <div class="row"><div>收入</div><div class="v green" id="sum-income">0</div></div>
            <div class="row"><div>支出</div><div class="v red" id="sum-expense">0</div></div>
            <div class="row"><div>結餘</div><div class="v red" id="sum-balance">0</div></div>
          </div>
        </div>
      </section>

      <div id="list-root"></div>
    </main>

    <nav class="tabbar" aria-label="Tab Bar">
      <div class="tabbar-inner">
        <a class="tab" href="add.html"><div class="icon">＋</div><div>新增</div></a>
        <a class="tab" href="month.html"><div class="icon">▦</div><div>本月</div></a>
        <a class="tab" href="year.html"><div class="icon">⛁</div><div>統計</div></a>
      </div>
    </nav>
  </div>

  <script type="module" src="app.js"></script>

  <script type="module">
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    // 修正：直接匯入 auth 與 db
    import { auth, db } from "./firebase-config.js";

    // 等待 Persistence 初始化
    await window.firebaseReady;

    // ===== month state (from ?m=YYYY-MM) =====
    const qs = new URLSearchParams(location.search);

    function pad2(n){ return String(n).padStart(2,"0"); }
    function monthKeyFromDate(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    }
    function parseMonthKey(key){
      if(!key || !/^\d{4}-\d{2}$/.test(key)) return null;
      const [y,m] = key.split("-").map(n => parseInt(n,10));
      if(!y || !m || m < 1 || m > 12) return null;
      return new Date(y, m-1, 1);
    }
    function addMonths(dateObj, delta){
      return new Date(dateObj.getFullYear(), dateObj.getMonth()+delta, 1);
    }
    function monthLabel(dateObj){
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, "0");
      return `${y}-${m}`;
    }

    let currentMonth = parseMonthKey(qs.get("m")) || new Date(new Date().getFullYear(), new Date().getMonth(), 1);
    const currentKey = monthKeyFromDate(currentMonth);
    const currentRef = `month.html?m=${currentKey}`;

    document.getElementById("monthLabel").textContent = monthLabel(currentMonth);

    document.getElementById("btnPrev").addEventListener("click", () => {
      const prev = addMonths(currentMonth, -1);
      location.href = `month.html?m=${monthKeyFromDate(prev)}`;
    });
    document.getElementById("btnNext").addEventListener("click", () => {
      const next = addMonths(currentMonth, 1);
      location.href = `month.html?m=${monthKeyFromDate(next)}`;
    });

    // ===== helpers =====
    function formatTime12h(hhmm){
      if(!hhmm) return "";
      const [hStr, mStr] = hhmm.split(":");
      let h = parseInt(hStr,10);
      const m = parseInt(mStr,10);
      const ampm = h >= 12 ? "PM" : "AM";
      h = h % 12; if(h === 0) h = 12;
      return `${h}:${String(m).padStart(2,"0")} ${ampm}`;
    }
    function ymdToDate(ymd){
      if(!ymd) return null;
      const [y,m,d] = ymd.split("-").map(n => parseInt(n,10));
      if(!y || !m || !d) return null;
      return new Date(y, m-1, d);
    }
    function formatDayHeader(ymd){
      const dt = ymdToDate(ymd);
      if(!dt) return ymd || "";
      const wd = dt.toLocaleDateString("en-US", { weekday:"short" });
      const mm = dt.getMonth() + 1;
      const dd = dt.getDate();
      return `${wd}, ${mm}/${dd}`;
    }
    function parseAmount(v){
      const n = Number(String(v ?? "").replace(/,/g,""));
      return (isFinite(n) ? n : 0);
    }

    // ===== rendering =====
    function buildTxRow(tx){
      const rawAmt = parseAmount(tx.amount);
      const isIncome = tx.type === "income";

      const a = document.createElement("a");
      a.className = "tx";
      a.dataset.id = tx.id;

      const params = new URLSearchParams();
      params.set("id", tx.id);
      params.set("ref", currentRef);
      if(tx.date) params.set("date", tx.date);
      if(tx.time) params.set("time", tx.time);
      params.set("type", tx.type || "expense");
      params.set("amount", String(rawAmt));
      params.set("cat", tx.category || "");
      params.set("note", tx.note || "");
      // 保持原始邏輯，連結到 edit.html
      a.href = "edit.html?" + params.toString();

      const left = document.createElement("div");
      const cat = document.createElement("div");
      cat.className = "cat";
      cat.textContent = tx.category || "";
      left.appendChild(cat);

      const noteTxt = (tx.note || "").trim();
      const note = document.createElement("div");
      note.className = "note";
      if(noteTxt){
        note.textContent = noteTxt;
      }else{
        note.style.display = "none";
      }
      left.appendChild(note);

      const right = document.createElement("div");
      right.className = "right";

      const amt = document.createElement("div");
      amt.className = "amt";
      amt.textContent = isIncome ? `+${rawAmt}` : `-${rawAmt}`;
      amt.style.color = isIncome ? "var(--green)" : "var(--red)";
      right.appendChild(amt);

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = formatTime12h(tx.time || "");
      right.appendChild(time);

      a.appendChild(left);
      a.appendChild(right);

      return a;
    }

    function renderWithTxs(txs){
      const root = document.getElementById("list-root");
      root.innerHTML = "";

      txs.sort((a,b) => {
        const da = (a.date || "");
        const db = (b.date || "");
        if(da !== db) return db.localeCompare(da);
        const ta = (a.time || "");
        const tb = (b.time || "");
        return tb.localeCompare(ta);
      });

      let income = 0, expense = 0;
      for(const tx of txs){
        const amt = parseAmount(tx.amount);
        if(tx.type === "income") income += amt;
        else expense += amt;
      }
      const balance = income - expense;

      document.getElementById("sum-income").textContent = String(income);
      document.getElementById("sum-expense").textContent = String(expense);

      const balEl = document.getElementById("sum-balance");
      balEl.textContent = String(balance);
      balEl.classList.remove("green","red");
      balEl.classList.add(balance >= 0 ? "green" : "red");

      if(txs.length === 0){
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "這個月份還沒有明細，去新增一筆吧！";
        root.appendChild(empty);
        return;
      }

      const groups = new Map();
      for(const tx of txs){
        const key = tx.date || "unknown";
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(tx);
      }

      const dates = Array.from(groups.keys()).sort((a,b) => b.localeCompare(a));
      for(const dateKey of dates){
        const section = document.createElement("section");
        section.className = "section";

        const list = groups.get(dateKey);

        const header = document.createElement("div");
        header.className = "day-header";

        const leftTitle = document.createElement("div");
        leftTitle.textContent = formatDayHeader(dateKey);

        let dayIncome = 0;
        let dayExpense = 0;
        for (const tx of list) {
          const amt = parseAmount(tx.amount);
          if (tx.type === "income") dayIncome += amt;
          else dayExpense += amt;
        }
        const dayNet = dayIncome - dayExpense;

        const rightTotal = document.createElement("div");
        rightTotal.className = "day-total";
        rightTotal.appendChild(document.createTextNode("總計 "));

        const v = document.createElement("span");
        v.className = "v " + (dayNet >= 0 ? "green" : "red");
        v.textContent = String(dayNet);
        rightTotal.appendChild(v);

        header.appendChild(leftTitle);
        header.appendChild(rightTotal);
        section.appendChild(header);

        const card = document.createElement("div");
        card.className = "day-card";

        list.forEach((tx, idx) => {
          card.appendChild(buildTxRow(tx));
          if(idx !== list.length - 1){
            const hr = document.createElement("hr");
            hr.className = "divider";
            card.appendChild(hr);
          }
        });

        section.appendChild(card);
        root.appendChild(section);
      }
    }

    function nextMonthKey(ym){
      const [y,m] = ym.split("-").map(n=>parseInt(n,10));
      const d = new Date(y, m-1, 1);
      const next = new Date(d.getFullYear(), d.getMonth()+1, 1);
      return monthKeyFromDate(next);
    }

    async function fetchMonthTxs(uid){
      const root = document.getElementById("list-root");
      root.innerHTML = "<div class='empty'>讀取中...</div>";

      // 修正：使用匯入的 db 變數，而不是 window.db
      const txRef = collection(db, "users", uid, "transactions");

      const start = `${currentKey}-01`;
      const end = `${nextMonthKey(currentKey)}-01`;

      const q = query(
        txRef,
        where("date", ">=", start),
        where("date", "<", end),
        orderBy("date", "desc"),
        orderBy("time", "desc")
      );

      const snap = await getDocs(q);
      const txs = [];
      snap.forEach(doc => {
        txs.push({ id: doc.id, ...doc.data() });
      });
      return txs;
    }

    // 修正：使用匯入的 auth 變數，而不是 window.auth
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // 如果確定未登入，才跳轉回首頁
        location.replace("index.html");
        return;
      }
      try {
        const txs = await fetchMonthTxs(user.uid);
        renderWithTxs(txs);
      } catch (e) {
        console.error("讀取失敗:", e);
        document.getElementById("list-root").innerHTML =
          "<div class='empty'>讀取失敗，請確認 Firestore 規則與索引</div>";
      }
    });
  </script>
</body>
</html>