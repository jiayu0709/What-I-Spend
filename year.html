<!doctype html>
<html lang="zh-Hant">
<head>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="theme.css">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="What I Spend">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>分析</title>
  <style>
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--app-bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    }
    .app{min-height:100vh;padding-bottom:var(--tab-height)}
    .page{max-width:520px;margin:0 auto;padding:18px var(--page-padding,16px) 28px}
    .nav-title{font-size:28px;font-weight:800;margin:0px 0 12px;transform: translateY(-4px);letter-spacing:-.5px;text-align:center}

    .monthbar{
      margin-top:6px;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .monthbar .m-btn{
      border:0;
      background: transparent;
      padding:10px 12px;
      border-radius: 12px;
      font-weight:900;
      color: var(--accent-text, var(--accent));
      cursor:pointer;
      appearance:none;
      -webkit-appearance:none;
    }
    .monthbar .m-title{
      font-weight:900;
      letter-spacing:-.2px;
      color: var(--text);
      white-space:nowrap;
    }
    .monthbar .m-title .bracket{
      color: var(--secondary);
      font-weight:900;
    }

    .card.card--empty{
      background: transparent;
      padding: 0;
    }

    .section{margin-top:18px}
    .label{font-size:16px;font-weight:900;color:var(--secondary);margin:12px 0 8px}
    .card{background:var(--card-bg);border-radius:var(--radius);padding:16px}

    .donut-wrap{display:grid;grid-template-columns:1fr;gap:14px;align-items:center;}
    .donut-area{display:grid;place-items:center;padding:8px 0 2px;}
    .donut-legend{margin-top:6px;display:grid;gap:12px;}
    .legend-row{
      display:grid;
      grid-template-columns:1fr auto auto;
      gap:10px;
      align-items:center;
      font-size:18px;
      padding:8px 0;
    }
    .legend-left{display:flex;align-items:center;gap:10px;min-width:0;}
    .dot{width:12px;height:12px;border-radius:999px;flex:0 0 auto;}
    .cat{
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pct{color:var(--secondary);font-weight:900;width:56px;text-align:right;}
    .amt{font-weight:900;width:110px;text-align:right;}
    .empty{
      background:rgba(255,255,255,0.5);
      border:1px solid rgba(0,0,0,0.06);
      border-radius:var(--radius);
      padding:14px 16px;
      color:var(--secondary);
      font-weight:800;
    }

    .donut-svg{width:260px;height:260px;display:block;}
    .center-title{font-size:18px;font-weight:900;fill:var(--secondary);}
    .center-value{font-size:26px;font-weight:900;fill:var(--text);}
  </style>
</head>
<body>
  <div class="app">
    <main class="page">
      <div class="nav-title">統計</div>

      <div class="monthbar" aria-label="月份切換">
        <button class="m-btn" type="button" id="btnPrev" aria-label="上一月">&lt;</button>
        <div class="m-title"><span id="monthLabel">January</span></div>
        <button class="m-btn" type="button" id="btnNext" aria-label="下一月">&gt;</button>
      </div>

      <section class="section">
        <div class="label" id="rangeLabel">支出分析</div>
        <div class="card" id="chartCard">
          <div id="chartRoot" class="donut-wrap"></div>
        </div>
      </section>
    </main>

    <nav class="tabbar" aria-label="Tab Bar">
      <div class="tabbar-inner">
        <a class="tab" href="add.html"><div class="icon">＋</div><div>新增</div></a>
        <a class="tab" href="month.html"><div class="icon">▦</div><div>本月</div></a>
        <a class="tab" href="year.html"><div class="icon">⛁</div><div>統計</div></a>
      </div>
    </nav>
  </div>

  <script type="module" src="app.js"></script>

  <script>
    // =========================
    // Utils (no behavior change)
    // =========================
    const $ = (id) => document.getElementById(id);

    const pad2 = (n) => String(n).padStart(2, "0");

    const monthKeyFromDate = (d) => `${d.getFullYear()}-${pad2(d.getMonth() + 1)}`;

    const parseMonthKey = (key) => {
      if (!key || !/^\d{4}-\d{2}$/.test(key)) return null;
      const [y, m] = key.split("-").map((n) => parseInt(n, 10));
      if (!y || !m || m < 1 || m > 12) return null;
      return new Date(y, m - 1, 1);
    };

    const addMonths = (dateObj, delta) =>
      new Date(dateObj.getFullYear(), dateObj.getMonth() + delta, 1);

    const monthLabel = (dateObj) =>
      `${dateObj.getFullYear()}-${pad2(dateObj.getMonth() + 1)}`;

    const parseAmount = (v) => {
      const n = Number(String(v ?? "").replace(/,/g, ""));
      return isFinite(n) ? n : 0;
    };

    const moneyNT = (n) => "NT$" + Math.round(n).toLocaleString("en-US");

    const clamp01 = (x) => Math.max(0, Math.min(1, x));

    // =========================
    // Month state: ?m=YYYY-MM
    // =========================
    const qs = new URLSearchParams(location.search);
    let currentMonth =
      parseMonthKey(qs.get("m")) ||
      new Date(new Date().getFullYear(), new Date().getMonth(), 1);

    const currentKey = monthKeyFromDate(currentMonth); // YYYY-MM

    // ✅ 新增：帳本（最小改動）
    const LS_BOOK = "wis_currentBookId";
    const urlBook = qs.get("b");
    if (urlBook) localStorage.setItem(LS_BOOK, urlBook);
    const currentBookId = localStorage.getItem(LS_BOOK) || "";

    $("monthLabel").textContent = monthLabel(currentMonth);
    $("rangeLabel").textContent = `支出分析（${currentMonth.getFullYear()}-${pad2(
      currentMonth.getMonth() + 1
    )}）`;

    $("btnPrev").addEventListener("click", () => {
      const prev = addMonths(currentMonth, -1);
      const m = monthKeyFromDate(prev);
      location.href = `year.html?m=${m}` + (currentBookId ? `&b=${encodeURIComponent(currentBookId)}` : "");
    });

    $("btnNext").addEventListener("click", () => {
      const next = addMonths(currentMonth, 1);
      const m = monthKeyFromDate(next);
      location.href = `year.html?m=${m}` + (currentBookId ? `&b=${encodeURIComponent(currentBookId)}` : "");
    });

    // =========================
    // LocalStorage helpers (保留原本程式碼，不刪不改)
    // =========================
    const getTxIndex = () => {
      try {
        const raw = localStorage.getItem("tx:index");
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    };

    const readTx = (id) => {
      const raw = localStorage.getItem("tx:" + id);
      if (!raw) return null;
      try {
        return JSON.parse(raw);
      } catch {
        return null;
      }
    };

    const isDeleted = (id) => localStorage.getItem("tx:deleted:" + id) === "1";

    // =========================
    // Donut (pure SVG)
    // =========================
    const polarToCartesian = (cx, cy, r, angleDeg) => {
      const rad = ((angleDeg - 90) * Math.PI) / 180;
      return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
    };

    const describeArc = (cx, cy, r, startAngle, endAngle) => {
      const start = polarToCartesian(cx, cy, r, endAngle);
      const end = polarToCartesian(cx, cy, r, startAngle);
      const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
      return ["M", start.x, start.y, "A", r, r, 0, largeArcFlag, 0, end.x, end.y].join(" ");
    };

    const palette = [
      "#f04b3a",
      "#d61c68",
      "#7c3aed",
      "#3b82f6",
      "#06b6d4",
      "#22c55e",
      "#f59e0b",
      "#a855f7",
      "#ef4444",
      "#10b981",
    ];

    const buildDonutSVG = (total, slices) => {
      const size = 260;
      const cx = size / 2;
      const cy = size / 2;
      const r = 92;
      const stroke = 34;

      let start = 0;

      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("viewBox", `0 0 ${size} ${size}`);
      svg.setAttribute("class", "donut-svg");

      const bg = document.createElementNS(svg.namespaceURI, "circle");
      bg.setAttribute("cx", cx);
      bg.setAttribute("cy", cy);
      bg.setAttribute("r", r);
      bg.setAttribute("fill", "none");
      bg.setAttribute("stroke", "rgba(0,0,0,0.06)");
      bg.setAttribute("stroke-width", stroke);
      svg.appendChild(bg);

      for (const s of slices) {
        const sweep = 360 * (s.value / total);
        const end = start + sweep;

        const path = document.createElementNS(svg.namespaceURI, "path");
        path.setAttribute("d", describeArc(cx, cy, r, start, end));
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", s.color);
        path.setAttribute("stroke-width", stroke);
        path.setAttribute("stroke-linecap", "butt");
        svg.appendChild(path);

        start = end;
      }

      const t1 = document.createElementNS(svg.namespaceURI, "text");
      t1.setAttribute("x", cx);
      t1.setAttribute("y", cy - 4);
      t1.setAttribute("text-anchor", "middle");
      t1.setAttribute("class", "center-title");
      t1.textContent = "Expenses";
      svg.appendChild(t1);

      const t2 = document.createElementNS(svg.namespaceURI, "text");
      t2.setAttribute("x", cx);
      t2.setAttribute("y", cy + 26);
      t2.setAttribute("text-anchor", "middle");
      t2.setAttribute("class", "center-value");
      t2.textContent = moneyNT(total);
      svg.appendChild(t2);

      return svg;
    };

    // =========================
    // Render chart（原本邏輯保留）
    // ✅ 只改：讓它可以吃「外部傳入的 txs」（Firestore），不再只靠 localStorage
    // =========================
    const renderMonthCategoryChart = (txs) => {
      const sumsByCat = new Map(); // category -> sum

      // ✅ 若沒傳入 txs，維持舊行為（localStorage）
      let sourceTxs = Array.isArray(txs) ? txs : [];
      if (!Array.isArray(txs)) {
        const ids = getTxIndex().filter(Boolean);
        const tmp = [];
        for (const id of ids) {
          if (isDeleted(id)) continue;
          const tx = readTx(id);
          if (tx) tmp.push(tx);
        }
        sourceTxs = tmp;
      }

      for (const tx of sourceTxs) {
        const date = String(tx.date || "");
        if (!date.startsWith(currentKey)) continue; // only this month (YYYY-MM)

        // expense only: exclude income; others treated as expense
        if (tx.type === "income") continue;

        const amt = parseAmount(tx.amount);
        if (amt <= 0) continue;

        const cat = (tx.category || "Uncategorized").trim() || "Uncategorized";
        sumsByCat.set(cat, (sumsByCat.get(cat) || 0) + amt);
      }

      const items = Array.from(sumsByCat.entries())
        .map(([name, value]) => ({ name, value }))
        .sort((a, b) => b.value - a.value);

      const root = $("chartRoot");
      const card = $("chartCard");
      root.innerHTML = "";

      if (items.length === 0) {
        card.classList.add("card--empty");

        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "這個月份還沒有支出資料，先去新增幾筆吧！";
        root.appendChild(empty);
        return;
      }

      card.classList.remove("card--empty");

      const total = items.reduce((s, x) => s + x.value, 0);

      // Top 8 + merge rest into "Other"
      const MAX = 8;
      const main = items.slice(0, MAX);
      const rest = items.slice(MAX);

      if (rest.length) {
        const restSum = rest.reduce((s, x) => s + x.value, 0);
        main.push({ name: "Other", value: restSum });
      }

      const slices = main.map((x, i) => ({
        ...x,
        color: palette[i % palette.length],
        pct: x.value / total,
      }));

      const donutArea = document.createElement("div");
      donutArea.className = "donut-area";
      donutArea.appendChild(buildDonutSVG(total, slices));

      const legend = document.createElement("div");
      legend.className = "donut-legend";

      for (const s of slices) {
        const row = document.createElement("div");
        row.className = "legend-row";

        const left = document.createElement("div");
        left.className = "legend-left";

        const dot = document.createElement("div");
        dot.className = "dot";
        dot.style.background = s.color;

        const cat = document.createElement("div");
        cat.className = "cat";
        cat.textContent = s.name;

        left.appendChild(dot);
        left.appendChild(cat);

        const pct = document.createElement("div");
        pct.className = "pct";
        pct.textContent = Math.round(clamp01(s.pct) * 100) + "%";

        const amt = document.createElement("div");
        amt.className = "amt";
        amt.textContent = moneyNT(s.value);

        row.appendChild(left);
        row.appendChild(pct);
        row.appendChild(amt);

        legend.appendChild(row);
      }

      root.appendChild(donutArea);
      root.appendChild(legend);
    };

    // ✅ 不再在這裡直接 render（因為要等 Firestore 資料）
    // renderMonthCategoryChart();

    // ✅ 只加：提供 module script 呼叫（不影響其他功能）
    window.__renderMonthCategoryChart = renderMonthCategoryChart;
    window.__currentKeyForStats = currentKey;

    // ✅ 新增：提供 module script 取用目前帳本（最小改動）
    window.__currentBookIdForStats = currentBookId;
  </script>

  <!-- ✅ 修正點：改用 Firestore 抓當月 transactions（跟 month.html 同資料來源） -->
  <script type="module">
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { db } from "./firebase-config.js";

    function nextMonthKey(ym){
      const [y,m] = ym.split("-").map(n => parseInt(n,10));
      const d = new Date(y, m-1, 1);
      const next = new Date(d.getFullYear(), d.getMonth()+1, 1);
      const mm = String(next.getMonth()+1).padStart(2,"0");
      return `${next.getFullYear()}-${mm}`;
    }

    async function fetchMonthTxs(uid, ym, bookId){
      const start = `${ym}-01`;
      const end = `${nextMonthKey(ym)}-01`;

      // ✅ 用傳進來的 bookId（不要在這裡再 const bookId = ...）
      if (!bookId) return [];

      const txRef = collection(db, "users", uid, "transactions");
      const q = query(
        txRef,
        where("bookId", "==", bookId),
        where("date", ">=", start),
        where("date", "<", end),
        orderBy("date", "desc"),
        orderBy("time", "desc")
      );

      const snap = await getDocs(q);
      const txs = [];
      snap.forEach(d => txs.push({ id: d.id, ...d.data() }));
      return txs;
    }

    // 1) 等 Firebase persistence ready
    await window.firebaseReady;

    // 2) 監聽登入狀態（你說「只有登入過後才能用」→ 未登入直接去 login）
    onAuthStateChanged(window.auth, async (user) => {
      if (!user) {
        const next = encodeURIComponent(location.href);
        location.replace(`login.html?next=${next}`);
        return;
      }

      const ym = window.__currentKeyForStats;               // "YYYY-MM"
      const bookId = window.__currentBookIdForStats || "";  // 來自 URL b 或 localStorage

      // 沒有 bookId：先用舊行為（localStorage render）
      if (!bookId) {
        window.__renderMonthCategoryChart();
        return;
      }

      try {
        const txs = await fetchMonthTxs(user.uid, ym, bookId);
        window.__renderMonthCategoryChart(txs);
      } catch (e) {
        console.error("統計頁讀取當月明細失敗（fallback localStorage）:", e);
        window.__renderMonthCategoryChart();
      }
    });
  </script>
</body>
</html>