<!doctype html>
<html lang="zh-Hant">
<head>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="theme.css">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="What I Spend">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>分析</title>
  <style>
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--app-bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    }
    .app{min-height:100vh;padding-bottom:var(--tab-height)}
    .page{max-width:520px;margin:0 auto;padding:18px var(--page-padding,16px) 28px}
    .nav-title{font-size:42px;font-weight:800;margin:10px 0 12px;letter-spacing:-.5px}

    /* ✅ 月份切換器（跟 month.html 同風格） */
    .monthbar{
      margin-top:6px;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .monthbar .m-btn{
      border:0;
      background: transparent;
      padding:10px 12px;
      border-radius: 12px;
      font-weight:900;
      color: var(--accent-text, var(--accent));
      cursor:pointer;
      appearance:none;
      -webkit-appearance:none;
    }
    .monthbar .m-title{
      font-weight:900;
      letter-spacing:-.2px;
      color: var(--text);
      white-space:nowrap;
    }
    .monthbar .m-title .bracket{
      color: var(--secondary);
      font-weight:900;
    }

    .section{margin-top:18px}
    .label{font-size:16px;font-weight:900;color:var(--secondary);margin:12px 0 8px}
    .card{background:var(--card-bg);border-radius:var(--radius);padding:16px}

    /* ===== Donut card ===== */
    .donut-wrap{display:grid;grid-template-columns:1fr;gap:14px;align-items:center;}
    .donut-area{display:grid;place-items:center;padding:8px 0 2px;}
    .donut-legend{margin-top:6px;display:grid;gap:12px;}
    .legend-row{
      display:grid;
      grid-template-columns:1fr auto auto;
      gap:10px;
      align-items:center;
      font-size:18px;
      padding:8px 0;
    }
    .legend-left{display:flex;align-items:center;gap:10px;min-width:0;}
    .dot{width:12px;height:12px;border-radius:999px;flex:0 0 auto;}
    .cat{
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pct{color:var(--secondary);font-weight:900;width:56px;text-align:right;}
    .amt{font-weight:900;width:110px;text-align:right;}
    .empty{
      background:rgba(255,255,255,0.5);
      border:1px solid rgba(0,0,0,0.06);
      border-radius:var(--radius);
      padding:14px 16px;
      color:var(--secondary);
      font-weight:800;
    }

    /* Donut SVG sizing */
    .donut-svg{width:260px;height:260px;display:block;}
    .center-title{font-size:18px;font-weight:900;fill:var(--secondary);}
    .center-value{font-size:26px;font-weight:900;fill:var(--text);}

    /* ===== Tab bar ===== */
    .tabbar{
      position:fixed;left:0;right:0;bottom:0;height:var(--tab-height);
      background:rgba(255,255,255,0.65);
      backdrop-filter:blur(18px);
      border-top:1px solid rgba(0,0,0,0.08);
      display:flex;justify-content:center;
    }
    .tabbar-inner{
      max-width:520px;width:100%;
      display:grid;grid-template-columns:repeat(3,1fr);
      padding:10px 18px 18px;gap:6px;align-items:center;
    }
    .tab{
      text-decoration:none;color:var(--secondary);
      display:grid;place-items:center;gap:6px;
      font-weight:800;padding:8px 0;
    }
    .tab .icon{font-size:24px;line-height:1}

    /* iOS tap */
    a, button, .tab{-webkit-tap-highlight-color:transparent;}
    .tab, button{
      user-select:none;-webkit-user-select:none;
      transition:opacity .15s ease, transform .10s ease, background-color .15s ease;
    }
    .tab:active{opacity:.6;transform:scale(.98);}
    button:active{opacity:.65;transform:scale(.98);}
    .tab:focus, button:focus{outline:none;}
  </style>
</head>
<body>
  <div class="app">
    <main class="page">
      <div class="nav-title">年度</div>

      <!-- ✅ 月份切換器 -->
      <div class="monthbar" aria-label="月份切換">
        <button class="m-btn" type="button" id="btnPrev" aria-label="上一月">‹</button>
        <div class="m-title">
          <span class="bracket">&lt;</span><span id="monthLabel">January</span><span class="bracket">&gt;</span>
        </div>
        <button class="m-btn" type="button" id="btnNext" aria-label="下一月">›</button>
      </div>

      <section class="section">
        <div class="label" id="rangeLabel">支出分析</div>
        <div class="card">
          <div id="chartRoot" class="donut-wrap"></div>
        </div>
      </section>
    </main>

    <!-- Tab Bar -->
    <nav class="tabbar" aria-label="Tab Bar">
      <div class="tabbar-inner">
        <a class="tab" href="add.html"><div class="icon">＋</div><div>新增</div></a>
        <a class="tab" href="month.html"><div class="icon">▦</div><div>本月</div></a>
        <a class="tab" href="year.html"><div class="icon">▲</div><div>年度</div></a>
      </div>
    </nav>
  </div>

  <script>
    // ===== month state: ?m=YYYY-MM =====
    const qs = new URLSearchParams(location.search);

    function pad2(n){ return String(n).padStart(2,"0"); }
    function monthKeyFromDate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }
    function parseMonthKey(key){
      if(!key || !/^\d{4}-\d{2}$/.test(key)) return null;
      const [y,m] = key.split("-").map(n => parseInt(n,10));
      if(!y || !m || m<1 || m>12) return null;
      return new Date(y, m-1, 1);
    }
    function addMonths(dateObj, delta){ return new Date(dateObj.getFullYear(), dateObj.getMonth()+delta, 1); }
    function monthLabel(dateObj){
      // 顯示英文月份（跟你 month.html 一樣）；如果要中文我也能改
      return dateObj.toLocaleDateString("en-US", { month:"long" });
    }

    let currentMonth = parseMonthKey(qs.get("m")) || new Date(new Date().getFullYear(), new Date().getMonth(), 1);
    const currentKey = monthKeyFromDate(currentMonth); // YYYY-MM

    document.getElementById("monthLabel").textContent = monthLabel(currentMonth);
    document.getElementById("rangeLabel").textContent = `支出分析（${currentMonth.getFullYear()}-${pad2(currentMonth.getMonth()+1)}）`;

    document.getElementById("btnPrev").addEventListener("click", () => {
      const prev = addMonths(currentMonth, -1);
      location.href = `year.html?m=${monthKeyFromDate(prev)}`;
    });
    document.getElementById("btnNext").addEventListener("click", () => {
      const next = addMonths(currentMonth, 1);
      location.href = `year.html?m=${monthKeyFromDate(next)}`;
    });

    // ===== storage helpers =====
    function getTxIndex(){
      try{
        const raw = localStorage.getItem("tx:index");
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function readTx(id){
      const raw = localStorage.getItem("tx:"+id);
      if(!raw) return null;
      try{ return JSON.parse(raw); }catch(e){ return null; }
    }
    function isDeleted(id){ return localStorage.getItem("tx:deleted:"+id) === "1"; }
    function parseAmount(v){
      const n = Number(String(v ?? "").replace(/,/g,""));
      return (isFinite(n) ? n : 0);
    }
    function moneyNT(n){ return "NT$" + Math.round(n).toLocaleString("en-US"); }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    // ===== Donut (pure SVG) =====
    function polarToCartesian(cx, cy, r, angleDeg){
      const rad = (angleDeg - 90) * Math.PI / 180;
      return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
    }
    function describeArc(cx, cy, r, startAngle, endAngle){
      const start = polarToCartesian(cx, cy, r, endAngle);
      const end = polarToCartesian(cx, cy, r, startAngle);
      const largeArcFlag = (endAngle - startAngle) <= 180 ? "0" : "1";
      return ["M", start.x, start.y, "A", r, r, 0, largeArcFlag, 0, end.x, end.y].join(" ");
    }

    const palette = ["#f04b3a","#d61c68","#7c3aed","#3b82f6","#06b6d4","#22c55e","#f59e0b","#a855f7","#ef4444","#10b981"];

    function buildDonutSVG(total, slices){
      const size = 260, cx=size/2, cy=size/2;
      const r = 92, stroke = 34;

      let start = 0;
      const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
      svg.setAttribute("viewBox", `0 0 ${size} ${size}`);
      svg.setAttribute("class","donut-svg");

      const bg = document.createElementNS(svg.namespaceURI,"circle");
      bg.setAttribute("cx", cx); bg.setAttribute("cy", cy); bg.setAttribute("r", r);
      bg.setAttribute("fill","none");
      bg.setAttribute("stroke","rgba(0,0,0,0.06)");
      bg.setAttribute("stroke-width", stroke);
      svg.appendChild(bg);

      slices.forEach(s => {
        const sweep = 360 * (s.value / total);
        const end = start + sweep;

        const path = document.createElementNS(svg.namespaceURI,"path");
        path.setAttribute("d", describeArc(cx, cy, r, start, end));
        path.setAttribute("fill","none");
        path.setAttribute("stroke", s.color);
        path.setAttribute("stroke-width", stroke);
        path.setAttribute("stroke-linecap", "butt");
        svg.appendChild(path);

        start = end;
      });

      const t1 = document.createElementNS(svg.namespaceURI,"text");
      t1.setAttribute("x", cx); t1.setAttribute("y", cy - 4);
      t1.setAttribute("text-anchor","middle");
      t1.setAttribute("class","center-title");
      t1.textContent = "Expenses";
      svg.appendChild(t1);

      const t2 = document.createElementNS(svg.namespaceURI,"text");
      t2.setAttribute("x", cx); t2.setAttribute("y", cy + 26);
      t2.setAttribute("text-anchor","middle");
      t2.setAttribute("class","center-value");
      t2.textContent = moneyNT(total);
      svg.appendChild(t2);

      return svg;
    }

    function renderMonthCategoryChart(){
      const ids = getTxIndex().filter(Boolean);
      const map = new Map(); // category -> sum

      for(const id of ids){
        if(isDeleted(id)) continue;
        const tx = readTx(id);
        if(!tx) continue;

        // ✅ 只統計「當月」
        const date = String(tx.date || "");
        if(!date.startsWith(currentKey)) continue; // YYYY-MM

        // ✅ 只統計支出：type === income 才排除；其他(含沒type)都當支出
        if(tx.type === "income") continue;

        const amt = parseAmount(tx.amount);
        if(amt <= 0) continue;

        const cat = (tx.category || "Uncategorized").trim() || "Uncategorized";
        map.set(cat, (map.get(cat) || 0) + amt);
      }

      const items = Array.from(map.entries())
        .map(([name,value]) => ({ name, value }))
        .sort((a,b) => b.value - a.value);

      const root = document.getElementById("chartRoot");
      root.innerHTML = "";

      if(items.length === 0){
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "這個月份還沒有支出資料，先去新增幾筆吧！";
        root.appendChild(empty);
        return;
      }

      const total = items.reduce((s,x)=>s+x.value,0);

      // 最多 8 類，其餘合併 Other
      const MAX = 8;
      let main = items.slice(0, MAX);
      const rest = items.slice(MAX);
      if(rest.length){
        const restSum = rest.reduce((s,x)=>s+x.value,0);
        main = main.concat([{ name:"Other", value:restSum }]);
      }

      const slices = main.map((x,i)=>({
        ...x,
        color: palette[i % palette.length],
        pct: x.value / total
      }));

      const donutArea = document.createElement("div");
      donutArea.className = "donut-area";
      donutArea.appendChild(buildDonutSVG(total, slices));

      const legend = document.createElement("div");
      legend.className = "donut-legend";

      slices.forEach(s => {
        const row = document.createElement("div");
        row.className = "legend-row";

        const left = document.createElement("div");
        left.className = "legend-left";

        const dot = document.createElement("div");
        dot.className = "dot";
        dot.style.background = s.color;

        const cat = document.createElement("div");
        cat.className = "cat";
        cat.textContent = s.name;

        left.appendChild(dot);
        left.appendChild(cat);

        const pct = document.createElement("div");
        pct.className = "pct";
        pct.textContent = Math.round(clamp01(s.pct)*100) + "%";

        const amt = document.createElement("div");
        amt.className = "amt";
        amt.textContent = moneyNT(s.value);

        row.appendChild(left);
        row.appendChild(pct);
        row.appendChild(amt);

        legend.appendChild(row);
      });

      root.appendChild(donutArea);
      root.appendChild(legend);
    }

    renderMonthCategoryChart();
  </script>
  <script src="app.js"></script>
</body>
</html>