<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <link rel="stylesheet" href="theme.css">
  <title>ËºâÂÖ•‰∏≠</title>
  <style>
    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      background: var(--app-bg);
      color: var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      padding: 0;
    }

    .wrap{
      min-height:100vh;
      display:grid;
      place-items:center;
      padding: 24px var(--page-padding, 16px);
    }

    .card{
      width:min(520px, 100%);
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: calc(var(--radius) + 6px);
      padding: 18px 16px;
      box-shadow:
        0 18px 50px rgba(0,0,0,0.08),
        0 1px 0 rgba(255,255,255,0.55) inset;
      text-align:center;
    }

    .logo{
      width: 72px;
      height: 72px;
      border-radius: 22px;
      display:grid;
      place-items:center;
      margin: 4px auto 12px;
      font-size: 42px;
      background: rgba(255,255,255,0.62);
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 1px 0 rgba(255,255,255,0.55) inset;
    }

    .title{
      font-size: 20px;
      font-weight: 900;
      letter-spacing: -0.2px;
      margin: 0;
    }

    .sub{
      margin-top: 8px;
      font-weight: 900;
      color: var(--secondary);
      font-size: 14px;
      line-height: 1.4;
    }

    .row{
      margin-top: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
    }

    .spinner{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 3px solid rgba(0,0,0,0.10);
      border-top-color: var(--accent-text);
      animation: spin .85s linear infinite;
    }

    @keyframes spin{
      to{ transform: rotate(360deg); }
    }

    .hint{
      margin-top: 12px;
      font-weight: 800;
      color: var(--secondary);
      font-size: 12px;
      opacity: .95;
    }

    /* subtle enter */
    .card{ animation: pop .22s ease-out; }
    @keyframes pop{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" role="status" aria-live="polite">
      <div class="logo">üí∞</div>
      <p class="title">Ê≠£Âú®ËºâÂÖ•‰Ω†ÁöÑÂ∏≥Êà∂‚Ä¶</p>

      <div class="row">
        <div class="spinner" aria-hidden="true"></div>
        <div class="sub">Ë´ãÁ®çÂÄô</div>
      </div>

      <div class="hint">Â¶ÇÊûú‰Ω†Â∑≤ÁôªÂÖ•ÔºåÊúÉËá™ÂãïÂ∏∂‰Ω†ÈÄ≤Âéª</div>
    </div>
  </div>

  <script type="module">
    import "./app.js";
    await window.firebaseReady;
    const user = await window.waitForAuthReady();

    const qs = new URLSearchParams(location.search);
    const next = qs.get("next") || "month.html";

    if (user) {
        location.replace(next);
    } else {
        // ‚úÖ Áõ¥Êé•Âéª loginÔºà‰∏¶Êää next Â∏∂ÈÅéÂéªÔºâ
        location.replace(`login.html?next=${encodeURIComponent(next)}`);
    }
  </script>
  <script type="module">
  const show = (msg) => {
    const p = document.createElement("pre");
    p.style.whiteSpace = "pre-wrap";
    p.style.fontSize = "12px";
    p.style.opacity = "0.9";
    p.style.marginTop = "10px";
    p.textContent = msg;
    document.querySelector(".card")?.appendChild(p);
  };

  // ‚úÖ Âº∑Âà∂ÁπûÈÅéÂø´ÂèñÔºàÈùûÂ∏∏ÈáçË¶ÅÔºöPWA / Netlify Â∏∏Â∏∏Âú®Áî®ËàäÊ™îÔºâ
  const V = "20260220_1";
  try {
    show("1) start‚Ä¶");
    await import(`./app.js?v=${V}`);
    show("2) app.js loaded");

    show("firebaseReady type = " + typeof window.firebaseReady);
    show("waitForAuthReady type = " + typeof window.waitForAuthReady);

    // Â¶ÇÊûúÈÄôÂÖ©ÂÄãÊòØ undefinedÔºå‰ª£Ë°® app.js Ê≤íË∑ëÂÆåÔºà‰∏≠ÈÄî errorÔºâ
    if (!window.firebaseReady || !window.waitForAuthReady) {
      throw new Error("app.js did not initialize window.firebaseReady / waitForAuthReady");
    }

    // Èò≤Ê≠¢Ê∞∏ÈÅ†Âç°‰Ωè
    const qs = new URLSearchParams(location.search);
    const next = qs.get("next") || "month.html";

    const t = setTimeout(() => {
      show("timeout -> go login");
      location.replace(`login.html?next=${encodeURIComponent(next)}`);
    }, 3000);

    await window.firebaseReady;
    show("3) firebaseReady done");

    const user = await window.waitForAuthReady();
    show("4) auth restored, user = " + (user?.uid || "null"));

    clearTimeout(t);

    if (user) location.replace(next);
    else location.replace(`login.html?next=${encodeURIComponent(next)}`);
  } catch (e) {
    show("ERROR: " + (e?.message || e));
    console.error(e);
  }
</script>
</body>
</html>