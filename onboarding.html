<!doctype html>
<html lang="zh-Hant">
<head>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="theme.css">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="What I Spend">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>é–‹å§‹ä½¿ç”¨</title>

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--app-bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    }

    .app{min-height:100vh;padding-bottom:28px}
    .page{max-width:520px;margin:0 auto;padding:18px var(--page-padding) 28px}

    .hero{
      margin-top:10px;
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:18px 16px;
    }
    .hero-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .logo{
      font-size:44px; line-height:1;
      width:56px;height:56px;border-radius:18px;
      background:rgba(255,255,255,0.55);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .hero-title{
      font-size:34px;
      font-weight:900;
      letter-spacing:-.5px;
      margin:8px 0 2px;
    }
    .hero-sub{
      color:var(--secondary);
      font-weight:800;
      margin:0;
      line-height:1.4;
    }

    .section{margin-top:16px}
    .card{
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:16px;
    }
    .h2{
      font-size:18px;
      font-weight:900;
      margin:0 0 10px;
      letter-spacing:-.2px;
    }
    .p{
      margin:0;
      color:var(--secondary);
      font-weight:800;
      line-height:1.5;
      font-size:14px;
    }

    .features{
      display:grid;
      gap:10px;
      margin-top:12px;
    }
    .feat{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:12px;
      border-radius:14px;
      background:rgba(255,255,255,0.55);
      border:1px solid rgba(0,0,0,0.06);
    }
    .feat .ic{font-size:18px; line-height:1.2; margin-top:1px;}
    .feat .tx{display:grid; gap:2px;}
    .feat .t{font-weight:900; color:var(--text); font-size:14px;}
    .feat .d{font-weight:800; color:var(--secondary); font-size:12px; line-height:1.4;}

    .tokenBox{
      display:grid;
      gap:10px;
      margin-top:12px;
    }
    .tokenRow{
      display:flex;
      gap:10px;
      align-items:stretch;
    }
    .token{
      flex:1;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid rgba(0,0,0,0.10);
      background:#fff;
      font-weight:900;
      color:var(--text);
      font-size:14px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }

    .btnbar{display:grid; gap:10px; margin-top:12px;}
    .btn{
      width:100%;
      padding:14px 16px;
      border:0;
      border-radius:var(--radius);
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      appearance:none;
      -webkit-appearance:none;
      background:rgba(255,255,255,0.55);
      border:1px solid rgba(0,0,0,0.06);
      color:var(--accent-text);
      text-decoration:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn.primary{
      background: var(--accent-text);
      color:#fff;
      border:0;
    }
    .btn.danger{
      background: rgba(217,74,74,0.12);
      color: #b33b3b;
      border:1px solid rgba(217,74,74,0.18);
    }

    .muted{
      margin-top:10px;
      font-size:12px;
      color:var(--secondary);
      font-weight:800;
      line-height:1.5;
    }

    .status{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      background:rgba(255,255,255,0.55);
      border:1px solid rgba(0,0,0,0.06);
      color:var(--secondary);
      font-weight:900;
      font-size:13px;
    }
    .status.ok{ color: var(--green); }
    .status.err{ color: var(--red); }

    /* iOS tap feedback */
    a, button { -webkit-tap-highlight-color: transparent; }
    .btn{
      user-select:none; -webkit-user-select:none;
      transition: opacity .15s ease, transform .10s ease, background-color .15s ease;
    }
    .btn:active{ opacity:.7; transform:scale(.99); }

    /* loading overlay */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.08);
      display:none;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .overlay.show{ display:flex; }
    .overlay .panel{
      width:min(420px, 92vw);
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:16px;
      border:1px solid rgba(0,0,0,0.08);
    }
    .overlay .panel .ttl{
      font-weight:900;
      font-size:16px;
      margin:0 0 6px;
    }
    .overlay .panel .sub{
      margin:0;
      color:var(--secondary);
      font-weight:800;
      font-size:13px;
      line-height:1.4;
    }
  </style>
</head>

<body>
  <div class="app">
    <main class="page">
      <section class="hero">
        <div class="hero-top">
          <div>
            <div class="hero-title">é–‹å§‹ä½¿ç”¨</div>
            <p class="hero-sub">æŠŠã€Œæ·å¾‘ Ã— é›²ç«¯åŒæ­¥ã€è¨­å®šå¥½<br>ä¹‹å¾Œå°±èƒ½èƒŒæ™¯å¿«é€Ÿè¨˜å¸³</p>
          </div>
          <div class="logo">ğŸ’°</div>
        </div>

        <div class="features">
          <div class="feat">
            <div class="ic">âœ…</div>
            <div class="tx">
              <div class="t">æ·å¾‘ä¸€éµè¨˜å¸³</div>
              <div class="d">ä¸ç”¨é–‹ç¶²é ã€è¼¸å…¥æ›´å¿«</div>
            </div>
          </div>
          <div class="feat">
            <div class="ic">â˜ï¸</div>
            <div class="tx">
              <div class="t">è‡ªå‹•åŒæ­¥é›²ç«¯</div>
              <div class="d">æ‰‹æ©Ÿ / é›»è…¦éƒ½èƒ½æŸ¥çœ‹èˆ‡ç·¨è¼¯</div>
            </div>
          </div>
          <div class="feat">
            <div class="ic">ğŸ”’</div>
            <div class="tx">
              <div class="t">æ¯å€‹äººç¨ç«‹ Token</div>
              <div class="d">ä½ çš„æ·å¾‘åªæœƒå¯«åˆ°ä½ è‡ªå·±çš„å¸³æˆ¶</div>
            </div>
          </div>
        </div>
      </section>

      <section class="section">
        <div class="card">
          <div class="h2">ä½ çš„æ·å¾‘å°ˆç”¨ Token</div>
          <p class="p">é€™æ˜¯ä½ çš„ã€Œæ·å¾‘é‘°åŒ™ã€ã€‚æ·å¾‘æœƒç”¨å®ƒæŠŠæ˜ç´°å¯«é€²ä½ çš„é›²ç«¯å¸³æˆ¶ã€‚</p>

          <div class="tokenBox">
            <div class="tokenRow">
              <div class="token" id="tokenText">è®€å–ä¸­â€¦</div>
              <button class="btn" type="button" id="copyBtn" style="width:auto; padding:0 14px;">
                ğŸ“‹ è¤‡è£½
              </button>
            </div>

            <a class="btn primary" id="installBtn" href="#" rel="noopener">
              ğŸš€ å®‰è£ iPhone å¿«é€Ÿè¨˜å¸³æ·å¾‘
            </a>

            <a class="btn" id="applyBtn" href="#" rel="noopener">
              âš¡ ä¸€éµæŠŠ Token å¥—ç”¨åˆ°æ·å¾‘
            </a>

            <button class="btn danger" type="button" id="resetBtn">
              â™»ï¸ é‡ç½® Tokenï¼ˆè®“èˆŠæ·å¾‘å¤±æ•ˆï¼‰
            </button>

            <div class="muted">
              å°æé†’ï¼šé‡ç½®å¾Œï¼Œä½ éœ€è¦é‡æ–°å®‰è£æˆ–æ›´æ–°æ·å¾‘è£¡çš„ Tokenã€‚å®‰è£å®Œæˆå¾Œï¼Œè«‹é»ã€Œä¸€éµæŠŠ Token å¥—ç”¨åˆ°æ·å¾‘ã€ã€‚
            </div>

            <div class="status" id="statusBox">ç‹€æ…‹ï¼šæº–å‚™ä¸­â€¦</div>
          </div>
        </div>
      </section>

      <section class="section">
        <div class="btnbar">
          <button class="btn primary" type="button" id="finishBtn">é–‹å§‹ä½¿ç”¨ â†’ é€²å…¥æœ¬æœˆ</button>
          <a class="btn" href="month.html">å…ˆè·³éï¼ˆä»å¯ä¹‹å¾Œå†è¨­å®šï¼‰</a>
        </div>
      </section>
    </main>
  </div>

  <div class="overlay" id="overlay">
    <div class="panel">
      <p class="ttl">è®€å–ä¸­â€¦</p>
      <p class="sub">æ­£åœ¨å–å¾—ä½ çš„ Tokenï¼Œè«‹ç¨å€™</p>
    </div>
  </div>

  <!-- âœ… ä½ åŸæœ¬çš„ persistence / requireAuth éƒ½åœ¨ app.js -->
  <script type="module" src="app.js"></script>

  <script type="module">
    import { doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { db } from "./firebase-config.js";

    // âœ… ä½ è¦æ›æˆä½ è‡ªå·±çš„ iCloud æ·å¾‘åˆ†äº«é€£çµ
    const SHORTCUT_ICLOUD_URL = "https://www.icloud.com/shortcuts/21c81e5e7eae49da9c1f2597e8f42a02";
    const RUN_SHORTCUT_NAME = "Setup";

    const tokenText = document.getElementById("tokenText");
    const copyBtn = document.getElementById("copyBtn");
    const installBtn = document.getElementById("installBtn");
    const applyBtn = document.getElementById("applyBtn");
    const resetBtn = document.getElementById("resetBtn");
    const finishBtn = document.getElementById("finishBtn");
    const statusBox = document.getElementById("statusBox");
    const overlay = document.getElementById("overlay");

    function showOverlay(msg="è®€å–ä¸­â€¦"){
      overlay.querySelector(".ttl").textContent = msg;
      overlay.classList.add("show");
    }
    function hideOverlay(){ overlay.classList.remove("show"); }

    function setStatus(text, type=""){
      statusBox.classList.remove("ok","err");
      if(type) statusBox.classList.add(type);
      statusBox.textContent = text;
    }

    function newToken(){
      // iOS 16+ / modern browsers ok
      return (crypto?.randomUUID?.() || (Date.now().toString(36) + Math.random().toString(36).slice(2)));
    }

    function buildInstallLink(){
      // iCloud å®‰è£é ä¸å¯é æ¥æ”¶ queryï¼Œåƒ…æä¾›ç´”å®‰è£é€£çµ
      return SHORTCUT_ICLOUD_URL;
    }

    function buildRunShortcutLink(token){
      const name = encodeURIComponent(RUN_SHORTCUT_NAME);
      const text = encodeURIComponent(token);
      return `shortcuts://run-shortcut?name=${name}&input=text&text=${text}`;
    }

    async function loadOrCreateToken(){
      showOverlay("è®€å– Tokenâ€¦");
      setStatus("ç‹€æ…‹ï¼šè®€å– Token ä¸­â€¦");

      await window.firebaseReady;
      const user = await window.requireAuth();
      if (!user) throw new Error("Not logged in");

      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);

      // users/{uid} ä¸å­˜åœ¨å°±å…ˆå»ºç«‹ï¼ˆä¿éšªï¼‰
      if (!snap.exists()) {
        await setDoc(ref, {
          createdAt: serverTimestamp(),
        }, { merge: true });
      }

      const data = (snap.exists() ? snap.data() : {});
      let token = data?.shortcutToken;

      if (!token) {
        token = newToken();
        await updateDoc(ref, {
          shortcutToken: token,
          shortcutTokenCreatedAt: serverTimestamp(),
        });
      }

      tokenText.textContent = token;
      installBtn.href = buildInstallLink();
      applyBtn.href = buildRunShortcutLink(token);
      applyBtn.removeAttribute("aria-disabled");
      applyBtn.style.pointerEvents = "";

      setStatus("ç‹€æ…‹ï¼šToken å·²æº–å‚™å¥½ âœ…", "ok");
      hideOverlay();
      return { user, token, ref };
    }

    async function resetToken(){
      showOverlay("é‡ç½® Tokenâ€¦");
      setStatus("ç‹€æ…‹ï¼šæ­£åœ¨é‡ç½® Tokenâ€¦");

      const user = await window.requireAuth();
      if (!user) throw new Error("Not logged in");

      const ref = doc(db, "users", user.uid);
      const token = newToken();

      await updateDoc(ref, {
        shortcutToken: token,
        shortcutTokenResetAt: serverTimestamp(),
      });

      tokenText.textContent = token;
      installBtn.href = buildInstallLink();
      applyBtn.href = buildRunShortcutLink(token);
      applyBtn.removeAttribute("aria-disabled");
      applyBtn.style.pointerEvents = "";

      setStatus("ç‹€æ…‹ï¼šå·²é‡ç½® âœ… è«‹é‡æ–°å®‰è£æ·å¾‘", "ok");
      hideOverlay();
    }

    async function finishOnboarding(){
      showOverlay("å®Œæˆè¨­å®šâ€¦");
      setStatus("ç‹€æ…‹ï¼šæ­£åœ¨å®Œæˆè¨­å®šâ€¦");

      const user = await window.requireAuth();
      if (!user) throw new Error("Not logged in");

      const ref = doc(db, "users", user.uid);
      await updateDoc(ref, {
        onboardingDone: true,
        onboardingDoneAt: serverTimestamp(),
      });

      hideOverlay();
      location.replace("month.html");
    }

    copyBtn.addEventListener("click", async () => {
      const token = (tokenText.textContent || "").trim();
      if (!token || token === "è®€å–ä¸­â€¦") return;

      try {
        await navigator.clipboard.writeText(token);
        setStatus("ç‹€æ…‹ï¼šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ âœ…", "ok");
      } catch (e) {
        // iOS æœ‰æ™‚ clipboard API æœƒå¤±æ•— â†’ fallback
        const r = document.createRange();
        r.selectNodeContents(tokenText);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(r);
        document.execCommand("copy");
        sel.removeAllRanges();
        setStatus("ç‹€æ…‹ï¼šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ âœ…", "ok");
      }
    });

    resetBtn.addEventListener("click", async () => {
      const ok = confirm("ç¢ºå®šè¦é‡ç½® Token å—ï¼Ÿ\né‡ç½®å¾ŒèˆŠæ·å¾‘æœƒå¤±æ•ˆï¼Œéœ€è¦é‡æ–°å®‰è£ã€‚");
      if (!ok) return;
      try { await resetToken(); }
      catch (e) {
        console.error(e);
        setStatus("ç‹€æ…‹ï¼šé‡ç½®å¤±æ•— âŒ " + (e.message || e), "err");
        hideOverlay();
      }
    });

    finishBtn.addEventListener("click", async () => {
      try { await finishOnboarding(); }
      catch (e) {
        console.error(e);
        setStatus("ç‹€æ…‹ï¼šå®Œæˆå¤±æ•— âŒ " + (e.message || e), "err");
        hideOverlay();
      }
    });

    // init
    applyBtn.setAttribute("aria-disabled","true");
    applyBtn.style.pointerEvents = "none";

    (async () => {
      try {
        await loadOrCreateToken();
      } catch (e) {
        console.error(e);
        setStatus("ç‹€æ…‹ï¼šè®€å–å¤±æ•— âŒ " + (e.message || e), "err");
        hideOverlay();
      }
    })();
  </script>
</body>
</html>