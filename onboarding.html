<!doctype html>
<html lang="zh-Hant">
<head>
  <!-- 1. ç¢ºä¿ manifest æœ€å…ˆè¼‰å…¥ -->
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="theme.css">
  
  <!-- 2. iOS PWA æ ¸å¿ƒæ¨™ç±¤ (å¿…é ˆå®Œæ•´) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- black-translucent èƒ½è®“é é¢å»¶ä¼¸åˆ°ç‹€æ…‹åˆ—ä¸‹æ–¹ï¼Œé”åˆ°æœ€å¾¹åº•çš„å…¨è¢å¹• -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="What I Spend">
  
  <!-- 3. ä¸€èˆ¬ PWA æ¨™ç±¤ -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#ffffff">
  
  <meta charset="utf-8" />
  <!-- viewport-fit=cover æ˜¯ç‚ºäº†è®“å…§å®¹å¡«æ»¿ç€æµ·å€åŸŸ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>é–‹å§‹ä½¿ç”¨</title>

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--app-bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      
      /* 4. é‡è¦ï¼šå› ç‚ºä½¿ç”¨äº† black-translucentï¼Œå¿…é ˆç•™å‡ºå®‰å…¨å€åŸŸé¿å…è¢«ç‹€æ…‹åˆ—é®æ“‹ */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    .app{min-height:100vh;padding-bottom:28px}
    .page{max-width:520px;margin:0 auto;padding:18px var(--page-padding) 28px}

    .hero{
      margin-top:10px;
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:18px 16px;
    }
    .hero-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .logo{
      font-size:44px; line-height:1;
      width:56px;height:56px;border-radius:18px;
      background:rgba(255,255,255,0.55);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .hero-title{
      font-size:34px;
      font-weight:900;
      letter-spacing:-.5px;
      margin:8px 0 2px;
    }
    .hero-sub{
      color:var(--secondary);
      font-weight:800;
      margin:0;
      line-height:1.4;
    }

    .section{margin-top:16px}
    .card{
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:16px;
    }
    .h2{
      font-size:18px;
      font-weight:900;
      margin:0 0 10px;
      letter-spacing:-.2px;
    }
    .p{
      margin:0;
      color:var(--secondary);
      font-weight:800;
      line-height:1.5;
      font-size:14px;
    }

    .features{
      display:grid;
      gap:10px;
      margin-top:12px;
    }
    .feat{
      display:flex;
      gap:10px;
      align-items:center;
      padding:12px;
      border-radius:14px;
      background:rgba(255,255,255,0.55);
      border:1px solid rgba(0,0,0,0.06);
    }
    .feat .ic{font-size:22px; line-height:1.2; margin-top:1px;}
    .feat .tx{display:grid; gap:2px;}
    .feat .t{font-weight:900; color:var(--text); font-size:14px;}
    .feat .d{font-weight:800; color:var(--secondary); font-size:12px; line-height:1.4;}

    .tokenBox{
      display:grid;
      gap:10px;
      margin-top:12px;
    }
    .tokenRow{
      display:flex;
      gap:10px;
      align-items:stretch;
    }
    .token{
      flex:1;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid rgba(0,0,0,0.10);
      background:#fff;
      font-weight:900;
      color:var(--text);
      font-size:14px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }

    .btnbar{display:grid; gap:10px; margin-top:12px;}
    .btn{
      width:100%;
      padding:14px 16px;
      border:0;
      border-radius:var(--radius);
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      appearance:none;
      -webkit-appearance:none;
      background:rgba(255,255,255,0.55);
      border:1px solid rgba(0,0,0,0.06);
      color:var(--accent-text);
      text-decoration:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn.primary{
      background: var(--accent-text);
      color:#fff;
      border:0;
    }

    .muted{
      margin-top:10px;
      font-size:12px;
      color:var(--secondary);
      font-weight:800;
      line-height:1.5;
    }

    .status{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      background:rgba(255,255,255,0.55);
      border:1px solid rgba(0,0,0,0.06);
      color:var(--secondary);
      font-weight:900;
      font-size:13px;
    }
    .status.ok{ color: var(--green); }
    .status.err{ color: var(--red); }

    a, button { -webkit-tap-highlight-color: transparent; }
    .btn{
      user-select:none; -webkit-user-select:none;
      transition: opacity .15s ease, transform .10s ease, background-color .15s ease;
    }
    .btn:active{ opacity:.7; transform:scale(.99); }

    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.08);
      display:none;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .overlay.show{ display:flex; }
    .overlay .panel{
      width:min(420px, 92vw);
      background: rgba(255,255,255,0.95);
      border-radius:var(--radius);
      padding:16px;
      border:1px solid rgba(0,0,0,0.08);
    }
    .overlay .panel .ttl{
      font-weight:900;
      font-size:16px;
      margin:0 0 6px;
    }
    .overlay .panel .sub{
      margin:0;
      color:var(--secondary);
      font-weight:800;
      font-size:13px;
      line-height:1.4;
    }

  </style>
</head>

<body>
  <div class="app">
    <main class="page">
      <section class="hero">
        <div class="hero-top">
          <div>
            <div class="hero-title">é–‹å§‹ä½¿ç”¨</div>
            <p class="hero-sub">æŠŠã€Œæ·å¾‘ Ã— é›²ç«¯åŒæ­¥ã€è¨­å®šå¥½<br>ä¹‹å¾Œå°±èƒ½èƒŒæ™¯å¿«é€Ÿè¨˜å¸³</p>
          </div>
          <div class="logo">ğŸ’°</div>
        </div>

        <div class="features">
          <div class="feat">
            <div class="ic">âœ…</div>
            <div class="tx">
              <div class="t">æ·å¾‘ä¸€éµè¨˜å¸³</div>
              <div class="d">ä¸ç”¨é–‹appã€å¿«é€Ÿè¨˜å¸³</div>
            </div>
          </div>
          <div class="feat">
            <div class="ic">â˜ï¸</div>
            <div class="tx">
              <div class="t">è‡ªå‹•åŒæ­¥é›²ç«¯</div>
              <div class="d">æ‰‹æ©Ÿ / é›»è…¦éƒ½èƒ½æŸ¥çœ‹èˆ‡ç·¨è¼¯</div>
            </div>
          </div>
          <div class="feat">
            <div class="ic">ğŸ”’</div>
            <div class="tx">
              <div class="t">æ¯å€‹äººç¨ç«‹å¸³æˆ¶</div>
              <div class="d">ç™»å…¥å¾Œæ‰€æœ‰è£ç½®éƒ½èƒ½çœ‹è¦‹è¨˜å¸³</div>
            </div>
          </div>
        </div>
      </section>


      <section class="section">
        <div class="card">
          <div class="h2">ä½ çš„ Setup Code</div>
          <p class="p">è«‹æŠŠé€™çµ„ Code è²¼åˆ°ã€ŒSetup Codeæ¬„ä½ã€æ·å¾‘è£¡ï¼ˆç¬¬ä¸€æ¬¡è¨­å®šç”¨ï¼‰ã€‚</p>

          <div class="tokenBox">
            <div class="tokenRow">
              <div class="token" id="codeText">è®€å–ä¸­â€¦</div>
              <button class="btn" type="button" id="copyBtn" style="width:auto; padding:0 14px;">
                ğŸ“‹ è¤‡è£½
              </button>
            </div>

            <a class="btn primary" id="installBtn" href="#" rel="noopener">
              ğŸš€ å®‰è£ iPhone å¿«é€Ÿè¨˜å¸³æ·å¾‘
            </a>

            <div class="muted">
              å®‰è£æ·å¾‘å¾Œï¼Œæ‰“é–‹æ·å¾‘åŸ·è¡Œä¸€æ¬¡ï¼Œè²¼ä¸Š Code å®Œæˆåˆå§‹åŒ–ã€‚
            </div>

            <div class="status" id="statusBox">ç‹€æ…‹ï¼šæº–å‚™ä¸­â€¦</div>
          </div>
        </div>
      </section>

      <section class="section">
        <div class="btnbar">
          <button class="btn primary" type="button" id="finishBtn">é–‹å§‹ä½¿ç”¨ â†’ é€²å…¥è¨˜å¸³</button>
          <a class="btn" href="month.html">å…ˆè·³éï¼ˆä»å¯ä¹‹å¾Œå†è¨­å®šï¼‰</a>
        </div>
      </section>
    </main>
  </div>

  <div class="overlay" id="overlay">
    <div class="panel">
      <p class="ttl">è®€å–ä¸­â€¦</p>
      <p class="sub">æ­£åœ¨ç”¢ç”Ÿä½ çš„ Setup Codeï¼Œè«‹ç¨å€™</p>
    </div>
  </div>

  <!-- âœ… è¼‰å…¥å…¨åŸŸé‚è¼¯ -->
  <script type="module" src="app.js"></script>

  <script type="module">
    import { auth as fbAuth, db } from "./firebase-config.js";
    import { doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // âœ… æ·å¾‘é€£çµ
    const SHORTCUT_ICLOUD_URL = "https://www.icloud.com/shortcuts/d908727fb1b64e51bf88f9b8886d7f82";

    const codeText = document.getElementById("codeText");
    const copyBtn = document.getElementById("copyBtn");
    const installBtn = document.getElementById("installBtn");
    const finishBtn = document.getElementById("finishBtn");
    const statusBox = document.getElementById("statusBox");
    const overlay = document.getElementById("overlay");

    function showOverlay(msg="è®€å–ä¸­â€¦"){
      overlay.querySelector(".ttl").textContent = msg;
      overlay.classList.add("show");
    }
    function hideOverlay(){ overlay.classList.remove("show"); }

    function setStatus(text, type=""){
      statusBox.classList.remove("ok","err");
      if(type) statusBox.classList.add(type);
      statusBox.textContent = text;
    }

    async function createSetupCodeViaFunction(){
      const u = fbAuth.currentUser;
      if (!u) throw new Error("å°šæœªåµæ¸¬åˆ°ç™»å…¥ç‹€æ…‹ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚");

      const idToken = await u.getIdToken();
      const res = await fetch("/.netlify/functions/createSetupCode", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${idToken}`,
        },
        body: JSON.stringify({}),
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || `ç”¢ç”Ÿ Code å¤±æ•— (${res.status})`);
      }

      return res.json();
    }

    copyBtn.addEventListener("click", async () => {
      const code = (codeText.textContent || "").trim();
      if (!code || code === "è®€å–ä¸­â€¦") return;

      try {
        await navigator.clipboard.writeText(code);
        setStatus("ç‹€æ…‹ï¼šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ âœ…", "ok");
      } catch (e) {
        const r = document.createRange();
        r.selectNodeContents(codeText);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(r);
        document.execCommand("copy");
        sel.removeAllRanges();
        setStatus("ç‹€æ…‹ï¼šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ âœ…", "ok");
      }
    });

    finishBtn.addEventListener("click", async () => {
      try {
        showOverlay("æ­£åœ¨å„²å­˜è¨­å®šâ€¦");
        await window.firebaseReady;
        const u = await window.requireAuth();
        if (u) {
          await updateDoc(doc(db, "users", u.uid), { onboardingDone: true });
        }
        location.replace("month.html");
      } catch (e) {
        console.error("set onboardingDone failed:", e);
        location.replace("month.html");
      }
    });

    // âœ… 5. å¼·åˆ¶åœ¨ PWA å…§éƒ¨é–‹å•Ÿæ‰€æœ‰åŒç¶²åŸŸé€£çµï¼Œé˜²æ­¢è·³å› Safari
    document.addEventListener('click', (e) => {
      const target = e.target.closest('a');
      if (target && target.href && target.hostname === window.location.hostname && !target.hasAttribute('download')) {
        // å¦‚æœä¸æ˜¯ target="_blank"
        if (target.target !== '_blank') {
          e.preventDefault();
          location.href = target.href;
        }
      }
    }, false);

    // åˆå§‹åŒ–åŸ·è¡Œ
    (async () => {
      try {
        showOverlay("æº–å‚™ç’°å¢ƒä¸­â€¦");
        if (window.firebaseReady) await window.firebaseReady;
        if (window.waitForAuthReady) {
          await window.waitForAuthReady();
        }
        const user = await window.requireAuth();
        if (!user) return; 

        showOverlay("ç”¢ç”Ÿ Setup Codeâ€¦");
        const { code } = await createSetupCodeViaFunction();

        codeText.textContent = code;
        installBtn.href = SHORTCUT_ICLOUD_URL;
        setStatus("ç‹€æ…‹ï¼šè«‹å®‰è£æ·å¾‘ä¸¦è²¼ä¸Šé€™çµ„ Code âœ…", "ok");
        hideOverlay();
      } catch (e) {
        console.error(e);
        setStatus("ç‹€æ…‹ï¼šè®€å–å¤±æ•— âŒ " + (e.message || e), "err");
        hideOverlay();
        if (e.message.includes("Not logged in")) {
          location.replace("login.html");
        }
      }
    })();
  </script>
</body>
</html>